<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Completo de Operativo Policial</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.2rem;
            color: #5a6c8d;
            font-weight: 400;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .section:hover {
            background: rgba(248, 250, 252, 0.7);
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: "";
            display: block;
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.95rem;
        }

        .required::after {
            content: " *";
            color: #e53e3e;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .readonly {
            background-color: #f8fafc;
            color: #64748b;
            cursor: not-allowed;
        }

        .auto-filled {
            background-color: #f0f9ff;
            border-color: #7dd3fc;
        }

        .hint {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
            font-style: italic;
        }

        .field-error {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-map {
            background: #10b981;
            color: white;
        }

        .btn-map:hover {
            background: #059669;
        }

        .btn-container {
            display: flex;
            justify-content: center;
            padding: 30px;
            background: rgba(248, 250, 252, 0.8);
        }

        .location-container {
            display: flex;
            gap: 10px;
        }

        .location-container input {
            flex: 1;
        }

        .map-container {
            display: none;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 400px;
            width: 100%;
        }

        .map-controls {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .map-search-container {
            position: relative;
            flex: 1;
        }

        .map-search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
        }

        .map-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .map-search-result {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .map-search-result:hover {
            background: #f8fafc;
        }

        .selected-location-info {
            padding: 15px;
            background: #f0f9ff;
            border-top: 1px solid #e2e8f0;
        }

        .delito-search-container {
            position: relative;
        }

        .delito-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .delito-search-result {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .delito-search-result:hover {
            background: #f8fafc;
        }

        .variable-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .subsection-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .variable-input-container {
            display: flex;
            align-items: center;
        }

        .variable-input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .variable-unit {
            padding: 12px 15px;
            background: #e2e8f0;
            border: 1.5px solid #e2e8f0;
            border-left: none;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            color: #64748b;
            font-weight: 500;
        }

        .validation-summary {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
        }

        .validation-summary.success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .validation-summary.error {
            background: #fef2f2;
            border: 1px solid #fecaca;
        }

        .validation-summary-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .validation-summary-item {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detenido-container {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .detenido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .detenido-title {
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detenido-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .remove-detenido {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .remove-detenido:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        .actions-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .detenido-counter {
            font-weight: 500;
            color: #6b7280;
            background: #f8fafc;
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }

        .indicadores-adicionales {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #10b981;
        }

        .indicadores-adicionales.active {
            display: block;
        }

        .indicadores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .progress-container {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px 30px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #2a5298, #667eea);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .powerpoint-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        }

        .file-input-wrapper {
            position: relative;
            margin-bottom: 10px;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            background: white;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-input-label:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .file-info {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .selected-file {
            display: none;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #7dd3fc;
            margin-bottom: 15px;
        }

        .file-name {
            font-weight: 500;
            color: #0369a1;
        }

        .file-size {
            color: #64748b;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .powerpoint-progress-bar {
            display: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .powerpoint-progress {
            height: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .drive-info {
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border: 1px solid #7dd3fc;
            margin-top: 15px;
        }

        .confirmation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirmation-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-message {
            background: white;
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .confirmation-overlay.show .confirmation-message {
            transform: translateY(0);
        }

        .confirmation-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .confirmation-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .confirmation-text {
            font-size: 1.1rem;
            color: #4b5563;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .btn-close {
            background: #6b7280;
            color: white;
        }

        .btn-close:hover {
            background: #4b5563;
        }

        .id-operativo-display {
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border-radius: 12px;
            border: 1px solid #7dd3fc;
            text-align: center;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6b7280;
            margin-left: auto;
        }

        .data-status {
            font-size: 0.85rem;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 6px;
        }

        .data-status.loading {
            background: #fef3c7;
            color: #92400e;
        }

        .data-status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .data-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .location-status {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .location-loading {
            color: #f59e0b;
        }

        .location-success {
            color: #10b981;
        }

        .location-error {
            color: #ef4444;
        }

        .permission-help {
            margin-top: 15px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            border: 1px solid #fbbf24;
        }

        .permission-help h4 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .permission-help ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .cedula-loading {
            display: none;
            margin-left: 10px;
            animation: spin 1s linear infinite;
        }

        .cedula-loading.active {
            display: inline-block;
        }

        .validation-icon {
            display: none;
            margin-left: 10px;
        }

        input.valid + .validation-icon.check {
            display: inline;
            color: #10b981;
        }

        input.invalid + .validation-icon.times {
            display: inline;
            color: #ef4444;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .form-container {
                padding: 15px;
            }
            
            .section {
                padding: 20px;
            }
            
            .location-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .notification {
                left: 20px;
                right: 20px;
                max-width: none;
            }
            
            .variables-grid {
                grid-template-columns: 1fr;
            }
            
            .map-controls {
                flex-direction: column;
            }
            
            .map-search-container {
                min-width: 100%;
            }
            
            .variable-input-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .variable-unit {
                margin-left: 0;
                margin-top: 5px;
                border-radius: 0 0 8px 8px;
                border-top: none;
                border-left: 1.5px solid #e2e8f0;
            }
            
            .variable-input {
                border-radius: 8px 8px 0 0;
            }
            
            .indicadores-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .confirmation-message {
                padding: 20px;
            }
            
            .confirmation-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- ========== NUEVO ELEMENTO: MENSAJE DE CONFIRMACI√ìN ========== -->
    <div class="confirmation-overlay" id="confirmationOverlay">
        <div class="confirmation-message">
            <div class="confirmation-icon">‚úÖ</div>
            <h2 class="confirmation-title">¬°Env√≠o Exitoso!</h2>
            <p class="confirmation-text" id="confirmationText">Las respuestas se han enviado correctamente.</p>
            <button class="btn btn-close" id="btnCloseConfirmation">Cerrar</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìã Formulario Completo de Operativo Policial</h1>
            <p>Sistema Integrado de Registro de Intervenciones y Detenidos</p>
        </div>

        <div class="form-container">
            <form id="operativeForm" autocomplete="off">
                <!-- Informaci√≥n General del Operativo -->
                <div class="section">
                    <h2 class="section-title">üìÖ Informaci√≥n General del Operativo</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fechaOperativo" class="required">Fecha del Operativo:</label>
                            <input type="date" id="fechaOperativo" name="fechaOperativo" required>
                            <div class="field-error" id="fechaOperativoError">La fecha es requerida</div>
                        </div>
                        <div class="form-group">
                            <label for="horaOperativo" class="required">Hora del Operativo:</label>
                            <input type="time" id="horaOperativo" name="horaOperativo" required>
                            <div class="field-error" id="horaOperativoError">La hora es requerida</div>
                        </div>
                        <div class="form-group">
                            <label for="direccionInterventora" class="required">Direcci√≥n Interventora:</label>
                            <select id="direccionInterventora" name="direccionInterventora" required>
                                <option value="">Seleccione una direcci√≥n...</option>
                                <option value="DNPJ">DNPJ</option>
                                <option value="DNA">DNA</option>
                                <option value="DINASED">DINASED</option>
                                <option value="DINIC">DINIC</option>
                                <option value="DINAF">DINAF</option>
                                <option value="DINITEC">DINITEC</option>
                                <option value="DNCTSV">DNCTSV</option>
                                <option value="DNPOLCO">DNPOLCO</option>
                                <option value="UNIDADES TRANSVERSALES">UNIDADES TRANSVERSALES</option>
                                <option value="DGI">DGI</option>
                                <option value="OTRO SERVICIO">OTRO SERVICIO</option>
                            </select>
                            <div class="field-error" id="direccionInterventoraError">Seleccione una direcci√≥n interventora</div>
                        </div>
                        <div class="form-group">
                            <label for="unidadInterventora" class="required">Unidad Interventora:</label>
                            <select id="unidadInterventora" name="unidadInterventora" required disabled>
                                <option value="">Primero seleccione una direcci√≥n...</option>
                            </select>
                            <div class="field-error" id="unidadInterventoraError">Seleccione una unidad interventora</div>
                            <div class="data-status" id="unidadesStatus"></div>
                        </div>
                        <div class="form-group">
                            <label for="codigoSubcircuito">C√≥digo de Subcircuito:</label>
                            <input type="text" id="codigoSubcircuito" name="codigoSubcircuito" 
                                   placeholder="Ej: 13D08C05S01">
                            <small class="hint">Ingrese el c√≥digo del subcircuito. Los datos de Zona, Subzona, etc. se cargar√°n autom√°ticamente.</small>
                            <div class="data-status" id="dataStatus"></div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="zona">Zona:</label>
                            <input type="text" id="zona" name="zona" class="readonly" readonly>
                        </div>
                        <div class="form-group">
                            <label for="subzona">Subzona:</label>
                            <input type="text" id="subzona" name="subzona" class="readonly" readonly>
                        </div>
                        <div class="form-group">
                            <label for="distrito">Distrito:</label>
                            <input type="text" id="distrito" name="distrito" class="readonly" readonly>
                        </div>
                        <div class="form-group">
                            <label for="circuito">Circuito:</label>
                            <input type="text" id="circuito" name="circuito" class="readonly" readonly>
                        </div>
                        <div class="form-group">
                            <label for="subcircuito">Subcircuito:</label>
                            <input type="text" id="subcircuito" name="subcircuito" class="readonly" readonly>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="latitud" class="required">Latitud:</label>
                            <div class="location-container">
                                <input type="text" id="latitud" name="latitud" 
                                       placeholder="Ej: -0,229850" 
                                       pattern="^-?\d{1,2},\d+$"
                                       required>
                                <button type="button" id="btnObtenerUbicacion" class="btn btn-submit">üìç GPS</button>
                                <button type="button" id="btnMostrarMapa" class="btn btn-map">üó∫Ô∏è Mapa</button>
                            </div>
                            <div class="field-error" id="latitudError">La latitud debe usar coma como separador decimal (Ej: -0,229850)</div>
                            <div class="location-status" id="locationStatus"></div>
                            <div class="permission-help" id="permissionHelp" style="display: none;">
                                <h4>Permiso de ubicaci√≥n denegado</h4>
                                <p>Para obtener la ubicaci√≥n autom√°ticamente:</p>
                                <ul>
                                    <li>Haga clic en el icono de candado en la barra de direcciones</li>
                                    <li>Permita el acceso a la ubicaci√≥n</li>
                                    <li>O intente nuevamente haciendo clic en "Obtener Ubicaci√≥n"</li>
                                </ul>
                                <p>Alternativamente, puede ingresar manualmente las coordenadas usando coma como separador decimal.</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="longitud" class="required">Longitud:</label>
                            <input type="text" id="longitud" name="longitud" 
                                   placeholder="Ej: -78,524950" 
                                   pattern="^-?\d{1,3},\d+$"
                                   required>
                            <div class="field-error" id="longitudError">La longitud debe usar coma como separador decimal (Ej: -78,524950)</div>
                        </div>
                    </div>

                    <!-- Nuevo campo de Direcci√≥n -->
                    <div class="form-grid">
                        <div class="form-group form-group-full">
                            <label for="direccion">Direcci√≥n:</label>
                            <textarea id="direccion" name="direccion" rows="3" 
                                      class="readonly"
                                      readonly
                                      placeholder="La direcci√≥n se cargar√° autom√°ticamente al seleccionar una ubicaci√≥n en el mapa o usar GPS..."></textarea>
                            <small class="hint">Este campo se llena autom√°ticamente con la direcci√≥n correspondiente a las coordenadas seleccionadas</small>
                        </div>
                    </div>

                    <!-- Contenedor del Mapa -->
                    <div class="map-container" id="mapContainer">
                        <div class="map-controls">
                            <div class="map-search-container">
                                <input type="text" id="mapSearch" class="map-search-input" 
                                       placeholder="Buscar direcci√≥n, lugar o punto de referencia...">
                                <div class="map-search-results" id="mapSearchResults"></div>
                            </div>
                            <button type="button" id="btnOcultarMapa" class="btn btn-secondary">‚ùå Ocultar Mapa</button>
                        </div>
                        <div id="map"></div>
                        <div class="selected-location-info" id="selectedLocationInfo">
                            <h4>üìç Ubicaci√≥n Seleccionada</h4>
                            <div class="location-details" id="locationDetails">
                                Coordenadas: <span id="selectedCoords"></span><br>
                                Direcci√≥n: <span id="selectedAddress">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Presunto Delito Intervenido -->
                <div class="section">
                    <h2 class="section-title">‚öñÔ∏è Presunto Delito Intervenido</h2>
                    <div class="form-grid">
                        <div class="form-group delito-search-container form-group-full">
                            <label for="presuntoDelito" class="required">Presunto Delito:</label>
                            <input type="text" id="presuntoDelito" name="presuntoDelito" 
                                   placeholder="Escriba para buscar delito..." required>
                            <div class="delito-search-results" id="delitoSearchResults"></div>
                            <div class="field-error" id="delitoError">Seleccione un presunto delito</div>
                            <small class="hint">Escriba para buscar entre los delitos disponibles</small>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group form-group-full">
                            <label for="extractoCaso" class="required">Extracto del Caso:</label>
                            <textarea id="extractoCaso" name="extractoCaso" rows="4" 
                                      placeholder="Describa brevemente los hechos ocurridos, contexto y detalles relevantes del caso..." 
                                      required></textarea>
                            <div class="field-error" id="extractoCasoError">El extracto del caso es requerido</div>
                            <small class="hint">Resumen narrativo de los hechos, incluyendo contexto, participantes y detalles relevantes</small>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoEjecucion" class="required">Tipo de Ejecuci√≥n de la Operaci√≥n:</label>
                            <select id="tipoEjecucion" name="tipoEjecucion" required>
                                <option value="">Seleccione...</option>
                                <option value="ACTO ADMINISTRATIVO">ACTO ADMINISTRATIVO</option>
                                <option value="ACTO URGENTE">ACTO URGENTE</option>
                                <option value="BOLETA DE DETENCI√ìN">BOLETA DE DETENCI√ìN</option>
                                <option value="FLAGRANCIA">FLAGRANCIA</option>
                                <option value="INVESTIGACI√ìN PREVIA">INVESTIGACI√ìN PREVIA</option>                                
                            </select>
                            <div class="field-error" id="tipoEjecucionError">Seleccione un tipo de ejecuci√≥n</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="tipoCoordinacion" class="required">Tipo de Coordinaci√≥n:</label>
                            <select id="tipoCoordinacion" name="tipoCoordinacion" required>
                                <option value="">Seleccione...</option>
                                <option value="ACTO ADMINISTRATIVO">ACTO ADMINISTRATIVO</option>
                                <option value="COORDINACI√ìN INSTITUCIONAL">COORDINACI√ìN INSTITUCIONAL</option>
                                <option value="COORDINACI√ìN INTERNACIONAL">COORDINACI√ìN INTERNACIONAL</option>                                
                            </select>
                            <div class="field-error" id="tipoCoordinacionError">Seleccione un tipo de coordinaci√≥n</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="caracterizacionAprehendido" class="required">Caracterizaci√≥n del Aprehendido/Detenido:</label>
                            <select id="caracterizacionAprehendido" name="caracterizacionAprehendido" required>
                                <option value="">Seleccione una caracterizaci√≥n...</option>
                                <option value="ACTO ADMINISTRATIVO">ACTO ADMINISTRATIVO</option>
                                <option value="ADMINISTRACI√ìN DE JUSTICIA">ADMINISTRACI√ìN DE JUSTICIA</option>
                                <option value="ASAMBLE√çSTAS">ASAMBLE√çSTAS</option>
                                <option value="DELINCUENCIA COM√öN">DELINCUENCIA COM√öN</option>
                                <option value="DIFUSI√ìN ROJA">DIFUSI√ìN ROJA</option>
                                <option value="FISCALES">FISCALES</option>
                                <option value="FUNCIONARIO DE GOBIERNO">FUNCIONARIO DE GOBIERNO</option>
                                <option value="JUECES">JUECES</option>
                                <option value="M√ÅS BUSCADO">M√ÅS BUSCADO</option>
                                <option value="MILITARES">MILITARES</option>
                                <option value="MINISTROS">MINISTROS</option>
                                <option value="OBJETIVO DE ALTO VALOR (OAV)">OBJETIVO DE ALTO VALOR (OAV)</option>
                                <option value="OBJETIVO DE INTERMEDIO VALOR (OIV)">OBJETIVO DE INTERMEDIO VALOR (OIV)</option>
                                <option value="POLIC√çAS">POLIC√çAS</option>
                                <option value="SERVIDORES P√öBLICOS">SERVIDORES P√öBLICOS</option>
                            </select>
                            <div class="field-error" id="caracterizacionAprehendidoError">Seleccione una caracterizaci√≥n</div>
                            <small class="hint">Seleccione el tipo de caracterizaci√≥n del aprehendido/detenido</small>
                        </div>
                    </div>
                </div>

                <!-- Variables de Productividad -->
                <div class="section" id="seccionVariablesProductividad">
                    <h2 class="section-title">üìà Variables de Productividad</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="variablesProductividad" class="required">Variables de Productividad:</label>
                            <select id="variablesProductividad" name="variablesProductividad" required>
                                <option value="">Seleccione una variable...</option>
                                <option value="Aeronaves (Und)">Aeronaves</option>
                                <option value="Allanamientos">Allanamientos</option>
                                <option value="Aprehendidos/Detenidos">Aprehendidos/Detenidos</option>
                                <option value="Armas de Fuego">Armas de Fuego</option>
                                <option value="Auditorias de Seguridad">Auditorias de Seguridad</option>
                                <option value="Autopartes y Autopartes de Vehiculos">Autopartes y Autopartes de Vehiculos</option>
                                <option value="Bienes Inmuebles Incautados">Bienes Inmuebles Incautados</option>
                                <option value="Cantidad Personas Desaparecidas Localizadas">Cantidad Personas Desaparecidas Localizadas</option>
                                <option value="Cap_Detonantes (Und)">Cap_Detonantes</option>
                                <option value="Celulares (Und)">Celulares</option>
                                <option value="Certificado de Armas Entregado">Certificado de Armas Entregado</option>
                                <option value="Cloruro de Calcio (Kg)">Cloruro de Calcio</option>
                                <option value="Coincidencias Potenciales de Vainas">Coincidencias Potenciales de Vainas</option>
                                <option value="Coordinacion con Upc">Coordinacion con Upc</option>
                                <option value="Combustibles">Combustibles</option>
                                <option value="Coordinaciones Realizadas">Coordinaciones Realizadas</option>
                                <option value="Deposito de Dinero Real">Deposito de Dinero Real</option>
                                <option value="Destiladores">Destiladores</option>
                                <option value="Destruccion de Dinero Falso">Destruccion de Dinero Falso</option>
                                <option value="Dinero en Cuentas Bancarias ($)">Dinero en Cuentas Bancarias</option>
                                <option value="Disposicion Final de Armas de Fuego">Disposicion Final de Armas de Fuego</option>
                                <option value="Disposicion Final de Automotores">Disposicion Final de Automotores</option>
                                <option value="Disposicion Final de Bienes Muebles E Inmuebles">Disposicion Final de Bienes Muebles e Inmuebles</option>
                                <option value="Disposicion Final de Municiones">Disposicion Final de Municiones</option>
                                <option value="Dolares Americanos ($)">Dolares Americanos</option>
                                <option value="Dolares Falsos ($)">Dolares Falsos</option>
                                <option value="Drogas">Drogas</option>
                                <option value="Embarcaciones (Und)">Embarcaciones</option>
                                <option value="Fauna Silvestre (Und)">Fauna Silvestre</option>
                                <option value="Fulminantes (Und)">Fulminantes</option>
                                <option value="Glp (15 - 45 Kg) (Und)">Glp (15 - 45 Kg)</option>
                                <option value="Granadas (Und)">Granadas</option>
                                <option value="Indique El Porcentaje de Cumplimiento de La Investigacion Previa (%)">Indique El Porcentaje de Cumplimiento de La Investigacion Previa</option>
                                <option value="Informacion Relevante (Sms-Audios)">Informacion Relevante (Sms-Audios)</option>
                                <option value="Informes de Analisis">Informes de Analisis</option>
                                <option value="Investigaciones Previas Aperturadas">Investigaciones Previas Aperturadas</option>
                                <option value="Laboratorio_Procesamiento_Droga">Laboratorio_Procesamiento_Droga</option>
                                <option value="Madera (M3)">Madera</option>
                                <option value="Maquinaria Pesada (Und)">Maquinaria Pesada</option>
                                <option value="Material Aurifero (Kg)">Material Aurifero</option>
                                <option value="Mecha Lenta Cordon Detonante (Metros)">Mecha Lenta Cordon Detonante</option>
                                <option value="Minas Detonantes (Und)">Minas Detonantes</option>
                                <option value="Motores F. Borda (Und)">Motores F. Borda</option>
                                <option value="Municiones (Und)">Municiones</option>
                                <option value="Ni√±os, Ni√±as y Adolescentes Rescatados">Ni√±os, Ni√±as y Adolescentes Rescatados</option>
                                <option value="Nitrato de Amonio (Kg)">Nitrato de Amonio</option>
                                <option value="Numero de La Investigacion Previa Aperturada">Numero de La Investigacion Previa Aperturada</option>
                                <option value="Operativos de Traslado">Operativos de Traslado</option>
                                <option value="Ordenes Judiciales de Analisis Telefonico Cumplidas">Ordenes Judiciales de Analisis Telefonico Cumplidas</option>
                                <option value="Patrimonio Cultural (Und)">Patrimonio Cultural</option>
                                <option value="Pentolita (Kg)">Pentolita</option>
                                <option value="Perdigones (Und)">Perdigones</option>
                                <option value="Perforaciones">Perforaciones</option>
                                <option value="Pericias Accidentologia Vial">Pericias Accidentologia Vial</option>
                                <option value="Pericias Criminalistica">Pericias Criminalistica</option>
                                <option value="Pericias Medicina Legal">Pericias Medicina Legal</option>
                                <option value="Personas Protegidas">Personas Protegidas</option>
                                <option value="Pirotecnia (Und)">Pirotecnia</option>
                                <option value="Piscinas Artesanales de Cldh">Piscinas Artesanales de Cldh</option>
                                <option value="Polvora (Kg)">Polvora</option>
                                <option value="Productos Agricolas (Bultos)">Productos Agricolas</option>
                                <option value="Quimicos Liquidos (Lt)">Quimicos Liquidos</option>
                                <option value="Quimicos Solidos (Kg)">Quimicos Solidos</option>
                                <option value="Registro de Medidas Cautelares">Registro de Medidas Cautelares</option>
                                <option value="Reportes Telefonicos Entregados">Reportes Telefonicos Entregados</option>
                                <option value="Semovientes (Und)">Semovientes</option>
                                <option value="Subzonas Intervenidas">Subzonas Intervenidas</option>
                                <option value="Tacos de Dinamita (Und)">Tacos de Dinamita</option>
                                <option value="Traslado de Indicios Bajo Pedido de Autoridad Competente">Traslado de Indicios Bajo Pedido de Autoridad Competente</option>
                                <option value="Valor de los Bienes Inmuebles Incautados">Valor de los Bienes Inmuebles Incautados</option>
                                <option value="Veh√≠culos">Veh√≠culos</option>
                                <option value="Victimas Liberadas">Victimas Liberadas</option>
                                <option value="V√≠ctimas Rescatadas">V√≠ctimas Rescatadas</option>
                                <option value="Varios">Varios</option>
                            </select>
                            <div class="field-error" id="variablesProductividadError">Seleccione una variable de productividad</div>
                            <small class="hint">Seleccione el tipo de variable de productividad del operativo</small>
                        </div>
                    </div>

                    <!-- Secciones din√°micas para cada variable -->
                    <div id="variableSectionsContainer">
                        <!-- Las secciones espec√≠ficas se generar√°n din√°micamente aqu√≠ -->
                    </div>

                    <!-- Resumen de validaciones -->
                    <div class="validation-summary" id="validationSummary">
                        <h3 class="validation-summary-title">üìã Resumen de Validaciones</h3>
                        <div id="validationSummaryContent"></div>
                    </div>
                </div>

                <!-- Registro de Detenidos -->
                <div class="section" id="seccionDetenidos" style="display: none;">
                    <h2 class="section-title">üë§ Registro de Detenidos</h2>
                    
                    <div id="detenidosContainer">
                        <!-- Los contenedores de detenidos se generar√°n din√°micamente aqu√≠ -->
                    </div>

                    <div class="actions-container">
                        <div class="detenido-counter">
                            <span id="totalDetenidos">0</span> detenido(s) registrado(s)
                        </div>
                    </div>
                </div>

                <!-- Indicadores Adicionales -->
                <div class="section" id="seccionIndicadoresAdicionales">
                    <h2 class="section-title">üìä Indicadores Adicionales</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nivelIndicadores">Desea ingresar m√°s indicadores?:</label>
                            <select id="nivelIndicadores" name="nivelIndicadores">
                                <option value="">Seleccione nivel...</option>
                                <option value="SI">SI</option>
                                <option value="NO">NO</option>
                            </select>
                            <small class="hint">Evaluaci√≥n del nivel de satisfacci√≥n ciudadana con el operativo</small>
                        </div> 
                    </div>

                    <!-- Secci√≥n de indicadores adicionales (se muestra cuando se selecciona SI) -->
                    <div class="indicadores-adicionales" id="indicadoresAdicionales">
                    </div>
                </div>

                <!-- Informaci√≥n del Responsable -->
                <div class="section" id="seccionResponsable">
                    <h2 class="section-title">üëÆ Responsable del Reporte</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="numeroCedula" class="required">N√∫mero de C√©dula:</label>
                            <input type="text" id="numeroCedula" name="numeroCedula" 
                                   placeholder="Ej: 0401400783" 
                                   pattern="[0-9]{10}" 
                                   maxlength="10" 
                                   required>
                            <span class="cedula-loading">üîÑ</span>
                            <span class="validation-icon check">‚úì</span>
                            <span class="validation-icon times">‚úó</span>
                            <div class="field-error" id="cedulaError">La c√©dula debe tener 10 d√≠gitos num√©ricos</div>
                            <small class="hint">Ingrese su n√∫mero de c√©dula (10 d√≠gitos). Los datos se cargar√°n autom√°ticamente.</small>
                            <div class="data-status" id="cedulaStatus"></div>
                        </div>
                        <div class="form-group">
                            <label for="grado" class="required">Grado:</label>
                            <input type="text" id="grado" name="grado" 
                                   class="readonly" 
                                   readonly 
                                   placeholder="Se cargar√° autom√°ticamente...">
                            <span class="validation-icon check">‚úì</span>
                            <span class="validation-icon times">‚úó</span>
                            <div class="field-error" id="gradoError">El grado se cargar√° autom√°ticamente al ingresar la c√©dula</div>
                        </div>
                        <div class="form-group">
                            <label for="apellidosNombres" class="required">Apellidos y Nombres:</label>
                            <input type="text" id="apellidosNombres" name="apellidosNombres" 
                                   class="readonly"
                                   readonly
                                   placeholder="Se cargar√° autom√°ticamente...">
                            <span class="validation-icon check">‚úì</span>
                            <span class="validation-icon times">‚úó</span>
                            <div class="field-error" id="nombresError">Los nombres se cargar√°n autom√°ticamente al ingresar la c√©dula</div>
                        </div>
                        <div class="form-group">
                            <label for="celular" class="required">Celular:</label>
                            <input type="tel" id="celular" name="celular" 
                                   class="readonly"
                                   readonly
                                   placeholder="Se cargar√° autom√°ticamente...">
                            <span class="validation-icon check">‚úì</span>
                            <span class="validation-icon times">‚úó</span>
                            <div class="field-error" id="celularError">El celular se cargar√° autom√°ticamente al ingresar la c√©dula</div>
                            <small class="hint">Este campo se llena autom√°ticamente con los datos del funcionario</small>
                        </div>
                        <div class="form-group">
                            <label for="correoElectronico" class="required">Correo Electronico:</label>
                            <input type="email" id="correoElectronico" name="correoElectronico" 
                                   class="readonly"
                                   readonly
                                   placeholder="Se cargar√° autom√°ticamente...">
                            <span class="validation-icon check">‚úì</span>
                            <span class="validation-icon times">‚úó</span>
                            <div class="field-error" id="correoError">El correo se cargar√° autom√°ticamente al ingresar la c√©dula</div>
                            <small class="hint">Este campo se llena autom√°ticamente con los datos del funcionario</small>
                        </div>
                    </div>
                </div>

                <!-- ========== SECCI√ìN: ENVIAR POWERPOINT ========== -->
                <div class="section powerpoint-section">
                    <h2 class="section-title">üìä Enviar PowerPoint</h2>
                    
                    <div class="form-grid">
                        <div class="form-group form-group-full">
                            <label for="powerpointFile">Seleccionar archivo PowerPoint:</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="powerpointFile" name="powerpointFile" 
                                       class="file-input" 
                                       accept=".ppt,.pptx,.pptm">
                                <label for="powerpointFile" class="file-input-label">
                                    <i>üìä</i>
                                    <span>Haga clic aqu√≠ para seleccionar un archivo PowerPoint</span>
                                </label>
                            </div>
                            <div class="file-info">
                                Formatos aceptados: PPT, PPTX, PPTM (Tama√±o m√°ximo: 50MB)
                            </div>
                            <div class="selected-file" id="selectedFile">
                                <p>
                                    <span class="file-name" id="fileName">Archivo seleccionado</span>
                                    <span class="file-size" id="fileSize">Tama√±o</span>
                                </p>
                            </div>
                            <div class="powerpoint-progress-bar" id="powerpointProgressBar">
                                <div class="powerpoint-progress" id="powerpointProgress"></div>
                            </div>
                            <div class="field-error" id="powerpointFileError">Debe seleccionar un archivo PowerPoint v√°lido</div>
                        </div>
                    </div>
                    
                    <div class="drive-info">
                        <p>üìÅ El archivo se guardar√° autom√°ticamente en <strong>Google Drive</strong> y se enviar√° por correo electr√≥nico a las autoridades correspondientes.</p>
                    </div>
                </div>

                <!-- Barra de progreso -->
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <!-- ========== BOT√ìN √öNICO ========== -->
                <div class="btn-container">
                    <button type="submit" class="btn btn-submit">
                        üì§ Enviar PowerPoint y Respuestas
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- √Årea de notificaciones -->
    <div id="notificationArea"></div>

    <!-- Agregar Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ========== CONFIGURACI√ìN CON LA URL √öNICA PROPORCIONADA ==========
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyHe2B-6g3vjT_I1vV2jb6587wSkcSGGCbdfZ_78yPIxOjOgigru5AlvBhegSqFpq23Bg/exec';

        // ========== NUEVA VARIABLE GLOBAL PARA INFO DRIVE ==========
        let infoDriveGlobal = {
            nombreArchivo: '',
            idOperativo: '',
            mensajeCompleto: ''
        };

        // ========== NUEVA FUNCI√ìN: ACTUALIZAR INFO DRIVE GLOBAL ==========
        function actualizarInfoDriveGlobal(idOperativo) {
            const nombreArchivo = `${idOperativo}_Informe_Operativo.pptx`;
            const mensajeCompleto = `El archivo se guardar√° autom√°ticamente en Google Drive con el nombre: ${nombreArchivo}`;
            
            infoDriveGlobal = {
                nombreArchivo: nombreArchivo,
                idOperativo: idOperativo,
                mensajeCompleto: mensajeCompleto
            };
            
            return infoDriveGlobal;
        }

        // ========== LISTA DE DELITOS ==========
        const listaDelitos = [
            "ABANDONO DE PERSONA", "ABIGEATO", "ABORTO CON MUERTE", "ABORTO CONSENTIDO", "ABORTO NO CONSENTIDO",
            "ABUSO DE ARMA DE FUEGO", "ABUSO DE CONFIANZA", "ABUSO DE EMBLEMAS", "ABUSO DE FACULTADES", "ABUSO SEXUAL",
            "ACOSO SEXUAL", "ACTIVIDAD ILICITA OF RECURSOS MINEROS", "ACTOS DE ODIO", "ACTOS HOSTILES CONTRA EL ESTADO",
            "ACUSACION O DENUNCIA MALICIOSA", "ADOPCION ILEGAL", "AGIOTAJE", "AGRESION", "ALTERACION DE EVIDENCIAS",
            "APOLOGIA", "APROPIACION FRAUDULENTA", "ARMAS DE FUEGO NO AUTORIZADAS", "ASESINATO", "ASOCIACION ILICITA",
            "ATAQUE A BIENES PROTEGIDOS", "ATAQUE O RESISTENCIA", "ATENTADO A LA INTEGRIDAD SEXUAL", "AUTORIZACION INDEBIDA",
            "CALUMNIA", "COHECHO", "COMERCIALIZACION DE PORNOGRAFIA", "COMERCIALIZACION ILICITA", "CONCUSION",
            "CONDUCCION BAJO EFECTO OF SUSTANCIAS", "CONDUCCION EN ESTADO OF EMBRIAGUEZ", "CONTACTO CON FINALIDAD SEXUAL",
            "CONTAMINACION OF SUSTANCIAS", "CONTABANDO", "CONTRAVENCION", "CORRUPCION OF MENORES", "DA√ëO A BIEN AJENO",
            "DA√ëO PERMANENTE A LA SALUD", "DA√ëOS MATERIALES", "DEFRAUDACION ADUANERA", "DEFRAUDACION TRIBUTARIA",
            "DELINCUENCIA ORGANIZADA", "DELITOS CONTRA EL AGUA", "DELITOS CONTRA LA FLORA Y FAUNA", "DESAPARICION FORZADA",
            "DESERTACION", "DESTRUCCION DE BIENES", "DIFUSION DE INFORMACION", "DISCRIMINACION", "EJECUCION EXTRAJUDICIAL",
            "EJERCICIO ILEGAL OF LA PROFESION", "ENRIQUECIMIENTO ILICITO", "ESCLAVITUD", "ESPIONAJE", "ESTAFA", "ESTUPRO",
            "EVASION", "EXPLOTACION SEXUAL", "EXTERMINIO", "EXTORSION", "FALSA INCRIMINACION", "FALSEDAD DOCUMENTAL",
            "FALSIFICACION DE FIRMAS", "FALSIFICACION OF MONEDA", "FEMICIDIO", "FINANCIACION DEL TERRORISMO", "FRAUDE",
            "GENOCIDIO", "HOMICIDIO", "HOMICIDIO CULPOSO", "HURTO", "HURTO A DOMICILIO", "HURTO A ENTIDADES FINANCIERAS",
            "INCENDIO", "INCENDIOS FORESTALES", "INCITACION A DISCORDIA", "INFRACCIONES", "INSUBORDINACION", "INTIMIDACION",
            "INVASION DE AREAS", "LAVADO DE ACTIVOS", "LESIONES", "MALTRATO A ANIMALES", "MANIPULACION GENETICA",
            "MUERTE CULPOSA", "NEGATIVA A PRESTAR AUXILIO", "OBSTACULIZACION OF PROCESO", "OCULTAMIENTO DE INFORMACION",
            "OMISION OF DENUNCIA", "PECULADO", "PERJURIO", "PORNOGRAFIA CON MENORES", "PREVARICATO", "PRIVACION ILEGAL DE LIBERTAD",
            "PRODUCCION ILICITA", "RECEPTACION", "RECLUTAMIENTO DE MENORES", "REVELACION DE SECRETO", "ROBO", "ROBO A DOMICILIO",
            "SABOTAJE", "SECUESTRO", "SECUESTRO EXTORSIVO", "SICARIATO", "SUMINISTRO OF SUSTANCIAS", "SUPLANTACION DE IDENTIDAD",
            "TENENCIA Y PORTE DE ARMAS", "TENTATIVA", "TERRORISMO", "TOMA OF REHENES", "TORTURA", "TOMA OF REHENES",
            "TRAFICO DE INFLUENCIAS", "TRAFICO DE ORGANOS", "TRAFICO ILICITO DE ARMAS", "TRAFICO ILICITO DE MIGRANTES",
            "TRAFICO ILICITO OF SUSTANCIAS", "TRATA DE PERSONAS", "USURA", "USURPACION", "VIOLACION", "VIOLACION A LA INTIMIDAD",
            "VIOLENCIA CONTRA LA MUJER", "VIOLENCIA FISICA", "VIOLENCIA PSICOLOGICA", "VIOLENCIA SEXUAL"
        ];

        // ========== DATOS DE UNIDADES ==========
        const datosUnidades = {
            "DNPJ": ["BAC", "POLICIA JUDICIAL", "UICA", "UIDH", "UNIC", "UNIDAE", "UNIDCAN", "UNIF"],
            "DNA": ["COORDINADOS DNA", "JEFATURA", "GEMA", "UCTCI", "UIACE", "UIAN", "UIPA", "UNSQ"],
            "DINASED": ["UIDP", "UMV", "UNASE"],
            "DINIC": ["UCAP", "UDAR", "UNDECOF"],
            "DINAF": ["DEVIF", "DINAPEN", "UNAT", "UNCIS"],
            "DINITEC": ["CRIMINALISTICA", "UNIVIAL"],
            "DNCTSV": ["DNCTSV"],
            "DNPOLCO": ["DNPOLCO"],
            "UNIDADES TRANSVERSALES": ["AMERIPOL", "CIBERPOL", "INTERPOL", "UDT", "UIAD", "ULCO", "UNAI", "UNDP", "UNIT", "UNRED"],
            "DGI": ["DGI"],
            "OTRO SERVICIO": ["SEGURIDAD PENITENCIARA", "ADUANA", "FUERZAS ARMADAS", "GUARDIA COSTERA EE.UU", "AGENTES MUNICIPALES"]
        };

        // ========== LISTA DE NACIONALIDADES ==========
        const nacionalidades = [
            "AFRICANA", "ALBANESA", "ALEMANA", "ANGOLENA", "ARGELINA", "ARGENTINA", "ARMENIA", "ASIATICA", "AUSTRALIANA", "AUTRALIANA", "AZERBAIJAN", 
            "BANGLADESI", "BELGA", "BELICENO",        "BENINES", "BIELORUSO", "BISAUGINEANA", "BOLIVIANA", "BRASILENA", "BRITANICA", "BULGARA", "BUTANESA", 
            "CABOVERDIANA", "CAMBOYANA", "CAMERUNES", "CANADIENSE", "CEILANA", "CEILANDESA", "CHADIANA", "CHECA", "CHILENA", "CHINA", "CHIPRIOTA", "COLOMBIANA", 
            "CONGOLESA", "COREANA", "COSTARRICENSE", "CROATA", "CUBANA", "DANESA", "DOMINICA", "DOMINICANA", "ECUATOGUINEANO", "ECUATORIANA", "EGIPCIO", 
            "ESPANOLA", "ESTADOUNIDENSE", "ESTONIA", "ESTONIANA", "ETIOPE", "FILIPINA", "FRANCESA", "GAMBIA", "GEORGIANA", "GHANESA", "GRIEGA", "GUANANO", 
            "GUATEMALTECA", "GUINEANA", "HAITIANA", "HINDU", "HOLANDESA", "HONDURENA", "HONGKONES", "HUNGARA", "INDONESA", "INDU", "INGLESA", "IRANI", 
            "IRLANDESA", "ISRAELITA", "ITALIANA", "JAPONESA", "JORDANA", "KIRGUINESA", "LETONIANA", "LIBANESA", "LIBIA", "LITUANA", "MACEDONIA", "MALASIA", 
            "MALAWI", "MALI", "MALTA", "MARFILENA", "MARROQUI", "MEXICANA", "MOLDAVA", "MONACO", "NEOZELANDESA", "NICARAGUENSE", "NIGERIANA", "NORTEAMERICANA", 
            "NORUEGA", "NUEVAGUINEANA", "PAKISTANI", "PALESTINA", "PANAMENA", "PAPUANA", "PARAGUAYA", "PERUANA", "POLACA", "PORTUGUESA", "PUERTORRIQUENA", 
            "REINO UNIDO", "RUMANA", "RUSA", "SAHARAUI", "SALOMONENSE", "SALVADORENA", "SAUDI", "SE DESCONOCE", "SENEGALES", "SERBIA", "SERBIO", "SIERRALEONESA", 
            "SINGAPURENSE", "SIRIA", "SOMALI", "SUDAFRICANA", "SUECA", "SUIZA", "SURCOREANA", "TAILANDESA", "TAIWANESA", "TAYIKA", "TOGOLES", "TURCA", "UCRANIANA", 
            "UGANDA", "UGANDESA", "URUGUAYA", "UZBECO",   "VANUATUENSE", "VATICANA", "VENEZOLANA", "VIETNAMITA", "YEMENI"
        ];

        // ========== LISTA DE GRUPOS DELICTIVOS ==========
        const gruposDelictivos = [
            "AGUILAS", "CHONE KILLERS", "CHONEROS", "FATALES",
            "GANGSTERS", "LAGARTOS", "LATIN KINGS", "LOBOS",
            "M18 TIBURONES", "R7", "TIGUERONES",
            "NINGUNO"
        ];

        // ========== LISTA DE RESOLUCIONES DE FLAGRANCIA ==========
        const resolucionesFlagrancia = [
            "AISLAMIENTO PREVENTIVO",
            "ARRESTO DOMICILIARIO", 
            "CONCILIACION",
            "EXPULSION DEL PAIS",
            "LIBRE CON INSTRUCCION FISCAL",
            "LIBRE CON INVESTIGACION PREVIA", 
            "LIBRE NO DELITO",
            "MEDIDA SUSTITUTIVA",
            "PRISION PREVENTIVA",
            "PROCEDIMIENTO ABREVIADO",
            "SE DESCONOCE"
        ];

        // ========== DEFINICI√ìN DE VARIABLES DE PRODUCTIVIDAD ==========
        const variablesProductividad = {
            "Aeronaves (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Allanamientos": {
                tipo: "numero",
                unidad: "Allanamientos",
                requerido: true,
                placeholder: "0"
            },
            "Aprehendidos/Detenidos": {
                tipo: "detalle_aprehendidos",
                unidad: "Personas",
                requerido: true,
                placeholder: "0",
                campos: {
                    "cantidad_aprehendidos": { label: "CANTIDAD APREHENDIDOS", tipo: "numero", requerido: true, placeholder: "0" },
                    "cantidad_detenidos": { label: "CANTIDAD DETENIDOS", tipo: "numero", requerido: true, placeholder: "0" },
                    "cantidad_hombres": { label: "CANTIDAD HOMBRES", tipo: "numero", requerido: true, placeholder: "0" },
                    "cantidad_mujeres": { label: "CANTIDAD MUJERES", tipo: "numero", requerido: true, placeholder: "0" }
                },
                validaciones: [
                    {
                        nombre: "Suma de g√©neros vs aprehendidos/detenidos",
                        descripcion: "La suma de CANTIDAD MUJERES + CANTIDAD HOMBRES debe ser igual a la suma de CANTIDAD APREHENDIDOS + CANTIDAD DETENIDOS",
                        validar: function(campos) {
                            const sumaGeneros = parseFloat(campos.cantidad_hombres || 0) + parseFloat(campos.cantidad_mujeres || 0);
                            const sumaAprehendidosDetenidos = parseFloat(campos.cantidad_aprehendidos || 0) + parseFloat(campos.cantidad_detenidos || 0);
                            return sumaGeneros === sumaAprehendidosDetenidos;
                        }
                    }
                ]
            },
            "Armas de Fuego": {
                tipo: "detalle_armas",
                unidad: "Armas",
                requerido: true,
                placeholder: "0",
                campos: {
                    "total_armas": { label: "TOTAL ARMAS", tipo: "numero", requerido: false, placeholder: "0" },
                    "ametralladora": { label: "AMETRALLADORA", tipo: "numero", requerido: false, placeholder: "0" },
                    "bazuca": { label: "BAZUCA", tipo: "numero", requerido: false, placeholder: "0" },
                    "canon": { label: "CA√ëON", tipo: "numero", requerido: false, placeholder: "0" },
                    "carabina": { label: "CARABINA", tipo: "numero", requerido: false, placeholder: "0" },
                    "cartuchera": { label: "CARTUCHERA", tipo: "numero", requerido: false, placeholder: "0" },
                    "escopeta": { label: "ESCOPETA", tipo: "numero", requerido: false, placeholder: "0" },
                    "fusil": { label: "FUSIL", tipo: "numero", requerido: false, placeholder: "0" },
                    "lanza_granada": { label: "LANZA GRANADA", tipo: "numero", requerido: false, placeholder: "0" },
                    "mortero": { label: "MORTERO", tipo: "numero", requerido: false, placeholder: "0" },
                    "pistola": { label: "PISTOLA", tipo: "numero", requerido: false, placeholder: "0" },
                    "pistolon": { label: "PISTOLON", tipo: "numero", requerido: false, placeholder: "0" },
                    "repetidora": { label: "REPETIDORA", tipo: "numero", requerido: false, placeholder: "0" },
                    "revolver": { label: "REVOLVER", tipo: "numero", requerido: false, placeholder: "0" },
                    "rifle": { label: "RIFLE", tipo: "numero", requerido: false, placeholder: "0" },
                    "subametralladora": { label: "SUBAMETRALLADORA", tipo: "numero", requerido: false, placeholder: "0" },
                    "otras_armas_fuego": { label: "OTRAS ARMAS DE FUEGO", tipo: "numero", requerido: false, placeholder: "0" }
                },
                validaciones: [
                    {
                        nombre: "Suma de tipos de armas vs total",
                        descripcion: "La suma de todos los tipos de armas debe ser igual al TOTAL ARMAS",
                        validar: function(campos) {
                            const sumaTiposArmas = 
                                parseFloat(campos.ametralladora || 0) +
                                parseFloat(campos.bazuca || 0) +
                                parseFloat(campos.canon || 0) +
                                parseFloat(campos.carabina || 0) +
                                parseFloat(campos.cartuchera || 0) +
                                parseFloat(campos.escopeta || 0) +
                                parseFloat(campos.fusil || 0) +
                                parseFloat(campos.lanza_granada || 0) +
                                parseFloat(campos.mortero || 0) +
                                parseFloat(campos.pistola || 0) +
                                parseFloat(campos.pistolon || 0) +
                                parseFloat(campos.repetidora || 0) +
                                parseFloat(campos.revolver || 0) +
                                parseFloat(campos.rifle || 0) +
                                parseFloat(campos.subametralladora || 0) +
                                parseFloat(campos.otras_armas_fuego || 0);
                            
                            const totalArmas = parseFloat(campos.total_armas || 0);
                            return sumaTiposArmas === totalArmas;
                        }
                    }
                ]
            },
            "Auditorias de Seguridad": {
                tipo: "numero",
                unidad: "Auditor√≠as",
                requerido: true,
                placeholder: "0"
            },
            "Autopartes y Autopartes de Vehiculos": {
                tipo: "numero",
                unidad: "Piezas",
                requerido: true,
                placeholder: "0"
            },
            "Bienes Inmuebles Incautados": {
                tipo: "numero",
                unidad: "Bienes",
                requerido: true,
                placeholder: "0"
            },
            "Cantidad Personas Desaparecidas Localizadas": {
                tipo: "numero",
                unidad: "Personas",
                requerido: true,
                placeholder: "0"
            },
            "Cap_Detonantes (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Celulares (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Certificado de Armas Entregado": {
                tipo: "numero",
                unidad: "Certificados",
                requerido: true,
                placeholder: "0"
            },
            "Cloruro de Calcio (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Coincidencias Potenciales de Vainas": {
                tipo: "numero",
                unidad: "Coincidencias",
                requerido: true,
                placeholder: "0"
            },
            "Coordinacion con Upc": {
                tipo: "numero",
                unidad: "Coordinaciones",
                requerido: true,
                placeholder: "0"
            },
            "Combustibles": {
                tipo: "detalle_combustibles",
                unidad: "Galones",
                requerido: true,
                placeholder: "0.00",
                step: "0.01",
                campos: {
                    "total_combustibles": { label: "TOTAL COMBUSTIBLES (GL)", tipo: "numero", requerido: true, placeholder: "0.00", step: "0.01" },
                    "diesel": { label: "DIESEL (GL)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "gasolina": { label: "GASOLINA (GL)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "gasolina_pesca": { label: "GASOLINA DE PESCA (GL)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" }
                },
                validaciones: [
                    {
                        nombre: "Suma de tipos de combustibles vs total",
                        descripcion: "La suma de DIESEL + GASOLINA + GASOLINA DE PESCA debe ser igual al TOTAL COMBUSTIBLES",
                        validar: function(campos) {
                            const sumaTiposCombustibles = 
                                parseFloat(campos.diesel || 0) +
                                parseFloat(campos.gasolina || 0) +
                                parseFloat(campos.gasolina_pesca || 0);
                            
                            const totalCombustibles = parseFloat(campos.total_combustibles || 0);
                            return sumaTiposCombustibles === totalCombustibles;
                        }
                    }
                ]
            },
            "Coordinaciones Realizadas": {
                tipo: "numero",
                unidad: "Coordinaciones",
                requerido: true,
                placeholder: "0"
            },
            "Deposito de Dinero Real": {
                tipo: "numero",
                unidad: "Dep√≥sitos",
                requerido: true,
                placeholder: "0"
            },
            "Destiladores": {
                tipo: "numero",
                unidad: "Destiladores",
                requerido: true,
                placeholder: "0"
            },
            "Destruccion de Dinero Falso": {
                tipo: "numero",
                unidad: "Cantidad",
                requerido: true,
                placeholder: "0"
            },
            "Dinero en Cuentas Bancarias ($)": {
                tipo: "numero",
                unidad: "D√≥lares",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Disposicion Final de Armas de Fuego": {
                tipo: "numero",
                unidad: "Armas",
                requerido: true,
                placeholder: "0"
            },
            "Disposicion Final de Automotores": {
                tipo: "numero",
                unidad: "Veh√≠culos",
                requerido: true,
                placeholder: "0"
            },
            "Disposicion Final de Bienes Muebles E Inmuebles": {
                tipo: "numero",
                unidad: "Bienes",
                requerido: true,
                placeholder: "0"
            },
            "Disposicion Final de Municiones": {
                tipo: "numero",
                unidad: "Municiones",
                requerido: true,
                placeholder: "0"
            },
            "Dolares Americanos ($)": {
                tipo: "numero",
                unidad: "D√≥lares",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Dolares Falsos ($)": {
                tipo: "numero",
                unidad: "D√≥lares",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Drogas": {
                tipo: "detalle_drogas",
                unidad: "Gramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01",
                campos: {
                    "total_drogas_gr": { label: "TOTAL DROGA (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "cocaina_gr": { label: "COCAINA (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "heroina_gr": { label: "HEROINA (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "marihuana_gr": { label: "MARIHUANA (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "sinteticas_gr": { label: "SINTETICAS (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "pasta_base_cocaina_gr": { label: "PASTA BASE DE COCAINA (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" },
                    "otras_drogas_gr": { label: "OTRAS DROGAS (GR)", tipo: "numero", requerido: false, placeholder: "0.00", step: "0.01" }
                },
                validaciones: [
                    {
                        nombre: "Suma de tipos de drogas vs total",
                        descripcion: "La suma de COCAINA + HEROINA + MARIHUANA + SINTETICAS + PASTA BASE DE COCAINA + OTRAS DROGAS debe ser igual al TOTAL DROGA",
                        validar: function(campos) {
                            const sumaTiposDrogas = 
                                parseFloat(campos.cocaina_gr || 0) +
                                parseFloat(campos.heroina_gr || 0) +
                                parseFloat(campos.marihuana_gr || 0) +
                                parseFloat(campos.sinteticas_gr || 0) +
                                parseFloat(campos.pasta_base_cocaina_gr || 0) +
                                parseFloat(campos.otras_drogas_gr || 0);
                            
                            const totalDrogas = parseFloat(campos.total_drogas_gr || 0);
                            return sumaTiposDrogas === totalDrogas;
                        }
                    }
                ]
            },
            "Embarcaciones (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Fauna Silvestre (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Fulminantes (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Glp (15 - 45 Kg) (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Granadas (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Indique El Porcentaje de Cumplimiento de La Investigacion Previa (%)": {
                tipo: "numero",
                unidad: "Porcentaje",
                requerido: true,
                placeholder: "0",
                min: "0",
                max: "100"
            },
            "Informacion Relevante (Sms-Audios)": {
                tipo: "numero",
                unidad: "Elementos",
                requerido: true,
                placeholder: "0"
            },
            "Informes de Analisis": {
                tipo: "numero",
                unidad: "Informes",
                requerido: true,
                placeholder: "0"
            },
            "Investigaciones Previas Aperturadas": {
                tipo: "numero",
                unidad: "Investigaciones",
                requerido: true,
                placeholder: "0"
            },
            "Laboratorio_Procesamiento_Droga": {
                tipo: "numero",
                unidad: "Laboratorios",
                requerido: true,
                placeholder: "0"
            },
            "Madera (M3)": {
                tipo: "numero",
                unidad: "Metros C√∫bicos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Maquinaria Pesada (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Material Aurifero (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Mecha Lenta Cordon Detonante (Metros)": {
                tipo: "numero",
                unidad: "Metros",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Minas Detonantes (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Motores F. Borda (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Municiones (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Ni√±os, Ni√±as y Adolescentes Rescatados": {
                tipo: "numero",
                unidad: "Personas",
                requerido: true,
                placeholder: "0"
            },
            "Nitrato de Amonio (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Numero de La Investigacion Previa Aperturada": {
                tipo: "texto",
                unidad: "N√∫mero",
                requerido: true,
                placeholder: "Ej: IP-2024-001"
            },
            "Operativos de Traslado": {
                tipo: "numero",
                unidad: "Operativos",
                requerido: true,
                placeholder: "0"
            },
            "Ordenes Judiciales de Analisis Telefonico Cumplidas": {
                tipo: "numero",
                unidad: "√ìrdenes",
                requerido: true,
                placeholder: "0"
            },
            "Patrimonio Cultural (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Pentolita (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Perdigones (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Perforaciones": {
                tipo: "numero",
                unidad: "Perforaciones",
                requerido: true,
                placeholder: "0"
            },
            "Pericias Accidentologia Vial": {
                tipo: "numero",
                unidad: "Pericias",
                requerido: true,
                placeholder: "0"
            },
            "Pericias Criminalistica": {
                tipo: "numero",
                unidad: "Pericias",
                requerido: true,
                placeholder: "0"
            },
            "Pericias Medicina Legal": {
                tipo: "numero",
                unidad: "Pericias",
                requerido: true,
                placeholder: "0"
            },
            "Personas Protegidas": {
                tipo: "numero",
                unidad: "Personas",
                requerido: true,
                placeholder: "0"
            },
            "Pirotecnia (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Piscinas Artesanales de Cldh": {
                tipo: "numero",
                unidad: "Piscinas",
                requerido: true,
                placeholder: "0"
            },
            "Polvora (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Productos Agricolas (Bultos)": {
                tipo: "numero",
                unidad: "Bultos",
                requerido: true,
                placeholder: "0"
            },
            "Quimicos Liquidos (Lt)": {
                tipo: "numero",
                unidad: "Litros",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Quimicos Solidos (Kg)": {
                tipo: "numero",
                unidad: "Kilogramos",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Registro de Medidas Cautelares": {
                tipo: "numero",
                unidad: "Registros",
                requerido: true,
                placeholder: "0"
            },
            "Reportes Telefonicos Entregados": {
                tipo: "numero",
                unidad: "Reportes",
                requerido: true,
                placeholder: "0"
            },
            "Semovientes (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Subzonas Intervenidas": {
                tipo: "numero",
                unidad: "Subzonas",
                requerido: true,
                placeholder: "0"
            },
            "Tacos de Dinamita (Und)": {
                tipo: "numero",
                unidad: "Unidades",
                requerido: true,
                placeholder: "0"
            },
            "Traslado de Indicios Bajo Pedido de Autoridad Competente": {
                tipo: "numero",
                unidad: "Traslados",
                requerido: true,
                placeholder: "0"
            },
            "Valor de los Bienes Inmuebles Incautados": {
                tipo: "numero",
                unidad: "D√≥lares",
                requerido: true,
                placeholder: "0.00",
                step: "0.01"
            },
            "Veh√≠culos": {
                tipo: "detalle_vehiculos",
                unidad: "Veh√≠culos",
                requerido: true,
                placeholder: "0",
                campos: {
                    "total_vehiculos": { label: "TOTAL VEH√çCULOS", tipo: "numero", requerido: false, placeholder: "0" },
                    "carros_aprehendidos": { label: "CARROS APREHENDIDOS", tipo: "numero", requerido: false, placeholder: "0" },
                    "carros_recuperados": { label: "CARROS RECUPERADOS", tipo: "numero", requerido: false, placeholder: "0" },
                    "motos_aprehendidas": { label: "MOTOS APREHENDIDAS", tipo: "numero", requerido: false, placeholder: "0" },
                    "motos_recuperadas": { label: "MOTOS RECUPERADAS", tipo: "numero", requerido: false, placeholder: "0" }
                },
                validaciones: [
                    {
                        nombre: "Suma de tipos de veh√≠culos vs total",
                        descripcion: "La suma de CARROS APREHENDIDOS + CARROS RECUPERADOS + MOTOS APREHENDIDAS + MOTOS RECUPERADAS debe ser igual al TOTAL VEH√çCULOS",
                        validar: function(campos) {
                            const sumaTiposVehiculos = 
                                parseFloat(campos.carros_aprehendidos || 0) +
                                parseFloat(campos.carros_recuperados || 0) +
                                parseFloat(campos.motos_aprehendidas || 0) +
                                parseFloat(campos.motos_recuperadas || 0);
                            
                            const totalVehiculos = parseFloat(campos.total_vehiculos || 0);
                            return sumaTiposVehiculos === totalVehiculos;
                        }
                    }
                ]
            },
            "Victimas Liberadas": {
                tipo: "numero",
                unidad: "Personas",
                requerido: true,
                placeholder: "0"
            },
            "V√≠ctimas Rescatadas": {
                tipo: "numero",
                unidad: "Personas",
                requerido: true,
                placeholder: "0"
            },
            "Varios": {
                tipo: "texto",
                unidad: "Descripci√≥n",
                requerido: true,
                placeholder: "Describa los elementos varios incautados..."
            }
        };

        // ========== VARIABLES GLOBALES ==========
        let detenidoCount = 0;
        let autoGeneratedDetentions = 0;
        let map;
        let marker;
        // ========== NUEVA VARIABLE GLOBAL PARA ALMACENAR DATOS ==========
        let datosVariablesGuardados = {};

        // ========== FUNCIONES PARA NOTIFICACIONES ==========
        function mostrarNotificacion(mensaje, tipo = 'info', tiempo = 5000) {
            const notificationArea = document.getElementById('notificationArea');
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            
            let icono = '‚ÑπÔ∏è';
            if (tipo === 'success') icono = '‚úÖ';
            if (tipo === 'error') icono = '‚ùå';
            if (tipo === 'warning') icono = '‚ö†Ô∏è';
            
            notification.innerHTML = `
                <span>${icono}</span>
                <span>${mensaje}</span>
                <button class="notification-close">√ó</button>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            notification.querySelector('.notification-close').addEventListener('click', () => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            });
            
            if (tiempo > 0) {
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.remove('show');
                        setTimeout(() => notification.remove(), 300);
                    }
                }, tiempo);
            }
        }

        // ========== FUNCI√ìN MEJORADA: MOSTRAR CONFIRMACI√ìN Y LIMPIAR ==========
        function mostrarConfirmacion() {
            const confirmationOverlay = document.getElementById('confirmationOverlay');
            
            if (confirmationOverlay) {
                confirmationOverlay.classList.add('show');
                
                // ‚úÖ Limpiar formulario despu√©s de mostrar confirmaci√≥n
                setTimeout(() => {
                    limpiarFormularioCompleto();
                }, 1000); // Limpiar 1 segundo despu√©s de mostrar confirmaci√≥n
                
                // ‚úÖ Cerrar autom√°ticamente despu√©s de 5 segundos
                setTimeout(() => {
                    confirmationOverlay.classList.remove('show');
                }, 5000);
            }
        }

        // ========== NUEVA FUNCI√ìN: GENERAR ID √öNICO COINCIDENTE ==========
        function generarIdOperativo() {
            const ahora = new Date();
            const a√±o = ahora.getFullYear();
            
            // üî• COINCIDIR EXACTAMENTE CON EL FORMATO DEL GOOGLE SCRIPT
            // Formato: OP-YYYY-XXXXXX-XXX (Ej: OP-2025-945621-713)
            const timestamp = ahora.getTime().toString();
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            // Tomar los √∫ltimos 6 d√≠gitos del timestamp
            const seisDigitos = timestamp.slice(-6);
            
            const idOperativo = `OP-${a√±o}-${seisDigitos}-${random}`;
            
            console.log('üÜî ID Operativo generado (coincidente):', idOperativo);
            return idOperativo;
        }

        // ========== NUEVA FUNCI√ìN: MOSTRAR ID EN INTERFAZ ==========
        function mostrarIdOperativo() {
            const idOperativo = generarIdOperativo();
            const nombreArchivoDrive = `${idOperativo}_Informe_Operativo.pptx`;
            const mensajeDrive = `El archivo se guardar√° autom√°ticamente en Google Drive con el nombre: ${nombreArchivoDrive}`;
            
            // Crear o actualizar elemento para mostrar el ID
            let idDisplay = document.getElementById('idOperativoDisplay');
            if (!idDisplay) {
                idDisplay = document.createElement('div');
                idDisplay.id = 'idOperativoDisplay';
                idDisplay.className = 'id-operativo-display';
                
                const header = document.querySelector('.header');
                header.appendChild(idDisplay);
            }
            
            idDisplay.innerHTML = `
                <div style="background: #e7f3ff; border: 2px solid #2a5298; border-radius: 8px; padding: 10px 15px; margin-top: 10px; text-align: center;">
                    <strong>üÜî ID del Operativo:</strong> 
                    <span style="font-family: monospace; font-size: 1.1em; color: #2a5298; font-weight: bold;">${idOperativo}</span>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        ${mensajeDrive}
                    </div>
                </div>
            `;
            
            // üî• ACTUALIZAR TAMBI√âN LA SECCI√ìN DE POWERPOINT
            actualizarSeccionPowerPoint(idOperativo);
            
            return idOperativo;
        }

        // ========== NUEVA FUNCI√ìN: ACTUALIZAR SECCI√ìN POWERPOINT ==========
        function actualizarSeccionPowerPoint(idOperativo) {
            const nombreArchivoDrive = `${idOperativo}_Informe_Operativo.pptx`;
            const mensajeDrive = `El archivo se guardar√° autom√°ticamente en Google Drive con el nombre: ${nombreArchivoDrive}`;
            
            const driveInfo = document.querySelector('.drive-info');
            if (driveInfo) {
                driveInfo.innerHTML = `
                    <p>üìÅ <strong>Informaci√≥n de Guardado en Drive:</strong></p>
                    <p style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #4285f4;">
                        ${mensajeDrive}
                    </p>
                    <div style="background: #fff3cd; padding: 8px; border-radius: 4px; margin: 8px 0; font-family: monospace; text-align: center;">
                        <strong>${nombreArchivoDrive}</strong>
                    </div>
                    <p style="font-size: 0.9em; color: #666;">El archivo se vincular√° autom√°ticamente a este operativo en el sistema.</p>
                `;
            }
            
            return nombreArchivoDrive;
        }

        // ========== NUEVA FUNCI√ìN: CONFIRMACI√ìN CON ID ==========
        function mostrarConfirmacionConId(idOperativo) {
            const confirmationOverlay = document.getElementById('confirmationOverlay');
            const confirmationText = document.getElementById('confirmationText');
            
            // üî• USAR LA INFORMACI√ìN GLOBAL CONSISTENTE
            const infoDrive = actualizarInfoDriveGlobal(idOperativo);
            
            if (confirmationText) {
                confirmationText.innerHTML = `
                    Las respuestas se han enviado correctamente.<br><br>
                    <strong>üÜî ID del Operativo:</strong> ${idOperativo}<br>
                    <strong>üìÅ Archivo en Drive:</strong> ${infoDrive.nombreArchivo}<br>
                    <small style="color: #666;">${infoDrive.mensajeCompleto}</small>
                `;
            }
            
            if (confirmationOverlay) {
                confirmationOverlay.classList.add('show');
                
                setTimeout(() => {
                    limpiarFormularioCompleto();
                }, 1000);
                
                setTimeout(() => {
                    confirmationOverlay.classList.remove('show');
                }, 8000);
            }
        }

        // ========== FUNCIONES DEL MAPA ==========
        function inicializarMapa() {
            // Inicializar el mapa centrado en Ecuador
            map = L.map('map').setView([-1.8312, -78.1834], 6);
            
            // Agregar capa de tiles de OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Agregar marcador inicial
            marker = L.marker([-1.8312, -78.1834], {
                draggable: true
            }).addTo(map);

            // Evento cuando se mueve el marcador
            marker.on('dragend', function(e) {
                const latlng = marker.getLatLng();
                actualizarCoordenadasDesdeMapa(latlng.lat, latlng.lng);
                obtenerDireccionDesdeCoordenadas(latlng.lat, latlng.lng);
            });

            // Evento cuando se hace clic en el mapa
            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                actualizarCoordenadasDesdeMapa(e.latlng.lat, e.latlng.lng);
                obtenerDireccionDesdeCoordenadas(e.latlng.lat, e.latlng.lng);
            });

            mostrarNotificacion('Mapa cargado correctamente. Haga clic en cualquier ubicaci√≥n o busque una direcci√≥n.', 'info', 5000);
        }

        function mostrarMapa() {
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.style.display = 'block';
            
            // Inicializar el mapa si no est√° inicializado
            if (!map) {
                setTimeout(() => {
                    inicializarMapa();
                }, 100);
            }
            
            // Ajustar el tama√±o del mapa
            setTimeout(() => {
                map.invalidateSize();
            }, 300);
        }

        function ocultarMapa() {
            document.getElementById('mapContainer').style.display = 'none';
        }

        function actualizarCoordenadasDesdeMapa(lat, lng) {
            document.getElementById('latitud').value = lat.toString().replace('.', ',');
            document.getElementById('longitud').value = lng.toString().replace('.', ',');
            
            validarCoordenadas();
            actualizarBarraProgreso();
            
            // Mostrar informaci√≥n de la ubicaci√≥n seleccionada
            document.getElementById('selectedLocationInfo').style.display = 'block';
            document.getElementById('selectedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        async function obtenerDireccionDesdeCoordenadas(lat, lng) {
            const addressElement = document.getElementById('selectedAddress');
            const direccionInput = document.getElementById('direccion');
            
            addressElement.textContent = 'Obteniendo direcci√≥n...';
            direccionInput.value = 'Obteniendo direcci√≥n...';
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                if (data && data.display_name) {
                    const direccion = data.display_name;
                    addressElement.textContent = direccion;
                    direccionInput.value = direccion;
                    
                    // Marcar el campo de direcci√≥n como v√°lido
                    direccionInput.classList.add('auto-filled');
                } else {
                    addressElement.textContent = 'Direcci√≥n no disponible';
                    direccionInput.value = 'Direcci√≥n no disponible';
                }
            } catch (error) {
                console.error('Error al obtener direcci√≥n:', error);
                addressElement.textContent = 'Error al obtener direcci√≥n';
                direccionInput.value = 'Error al obtener direcci√≥n';
            }
        }

        async function buscarDireccion(query) {
            const resultsContainer = document.getElementById('mapSearchResults');
            resultsContainer.innerHTML = '';
            
            if (!query || query.length < 3) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=ec`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    data.forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'map-search-result';
                        div.textContent = result.display_name;
                        div.addEventListener('click', function() {
                            const lat = parseFloat(result.lat);
                            const lon = parseFloat(result.lon);
                            
                            map.setView([lat, lon], 16);
                            marker.setLatLng([lat, lon]);
                            actualizarCoordenadasDesdeMapa(lat, lon);
                            obtenerDireccionDesdeCoordenadas(lat, lon);
                            
                            resultsContainer.style.display = 'none';
                            document.getElementById('mapSearch').value = result.display_name;
                        });
                        resultsContainer.appendChild(div);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error en b√∫squeda de direcci√≥n:', error);
                resultsContainer.style.display = 'none';
            }
        }

        // ========== FUNCI√ìN MODIFICADA PARA GUARDAR DATOS ANTES DE CAMBIAR ==========
        function gestionarVariableProductividad() {
            const variableSeleccionada = document.getElementById('variablesProductividad').value;
            const container = document.getElementById('variableSectionsContainer');
            const validationSummary = document.getElementById('validationSummary');
            
            // üî• GUARDAR DATOS DE LA VARIABLE ACTUAL ANTES DE CAMBIAR
            guardarDatosVariableActual();
            
            // Limpiar contenedor
            container.innerHTML = '';
            validationSummary.style.display = 'none';
            
            if (!variableSeleccionada) {
                document.getElementById('seccionDetenidos').style.display = 'none';
                return;
            }
            
            const configVariable = variablesProductividad[variableSeleccionada];
            if (!configVariable) {
                mostrarNotificacion('Error: Configuraci√≥n no encontrada para esta variable', 'error', 3000);
                return;
            }
            
            // Crear secci√≥n para la variable seleccionada
            const section = document.createElement('div');
            section.className = 'variable-section active';
            section.id = `section-${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '-')}`;
            
            let inputHTML = '';
            
            if (configVariable.tipo === 'numero' || configVariable.tipo === 'texto') {
                const fieldId = `valor_${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                // üî• OBTENER VALOR GUARDADO SI EXISTE
                const valorGuardado = datosVariablesGuardados[fieldId] || '';
                
                if (configVariable.tipo === 'numero') {
                    inputHTML = `
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="${fieldId}" class="required">Cantidad de ${variableSeleccionada}:</label>
                                <div class="variable-input-container">
                                    <input type="number" 
                                           id="${fieldId}" 
                                           name="${fieldId}"
                                           class="variable-input"
                                           ${configVariable.requerido ? 'required' : ''}
                                           min="${configVariable.min || '0'}"
                                           max="${configVariable.max || ''}"
                                           step="${configVariable.step || '1'}"
                                           placeholder="${configVariable.placeholder}"
                                           value="${valorGuardado}"
                                           data-variable="${variableSeleccionada}">
                                    <span class="variable-unit">${configVariable.unidad}</span>
                                </div>
                                <div class="field-error" id="${fieldId}Error">Este campo es requerido</div>
                                <small class="hint">Ingrese la cantidad de ${variableSeleccionada.toLowerCase()}</small>
                            </div>
                        </div>
                    `;
                } else if (configVariable.tipo === 'texto') {
                    inputHTML = `
                        <div class="form-grid">
                            <div class="form-group form-group-full">
                                <label for="${fieldId}" class="required">${variableSeleccionada}:</label>
                                <input type="text" 
                                       id="${fieldId}" 
                                       name="${fieldId}"
                                       class="variable-input"
                                       ${configVariable.requerido ? 'required' : ''}
                                       placeholder="${configVariable.placeholder}"
                                       value="${valorGuardado}"
                                       data-variable="${variableSeleccionada}">
                                <div class="field-error" id="${fieldId}Error">Este campo es requerido</div>
                                <small class="hint">${configVariable.unidad}: ${configVariable.placeholder}</small>
                            </div>
                        </div>
                    `;
                }
            } else if (configVariable.tipo.startsWith('detalle_')) {
                inputHTML = generarCamposDetallados(variableSeleccionada, configVariable);
            }
            
            section.innerHTML = `
                <h3 class="subsection-title">üìä ${variableSeleccionada}</h3>
                ${inputHTML}
            `;
            
            container.appendChild(section);
            
            // Agregar event listeners
            if (configVariable.tipo === 'numero' || configVariable.tipo === 'texto') {
                const fieldId = `valor_${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const inputElement = document.getElementById(fieldId);
                if (inputElement) {
                    inputElement.addEventListener('input', function() {
                        validarVariableProductividad(this);
                        actualizarBarraProgreso();
                        // üî• GUARDAR DATOS AUTOM√ÅTICAMENTE AL ESCRIBIR
                        guardarDatosVariableActual();
                    });
                }
            } else if (configVariable.tipo.startsWith('detalle_')) {
                agregarEventListenersCamposDetallados(variableSeleccionada, configVariable);
            }
            
            actualizarBarraProgreso();
        }

        // ========== FUNCI√ìN MODIFICADA PARA GENERAR CAMPOS DETALLADOS CON DATOS GUARDADOS ==========
        function generarCamposDetallados(variableSeleccionada, configVariable) {
            let camposHTML = '';
            
            if (configVariable.campos) {
                camposHTML = '<div class="form-grid">';
                
                Object.entries(configVariable.campos).forEach(([campoId, configCampo]) => {
                    const campoCompletoId = `${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}_${campoId}`;
                    
                    // üî• OBTENER VALOR GUARDADO SI EXISTE
                    const valorGuardado = datosVariablesGuardados[campoCompletoId] || '';
                    
                    if (configCampo.tipo === 'numero') {
                        camposHTML += `
                            <div class="form-group">
                                <label for="${campoCompletoId}" ${configCampo.requerido ? 'class="required"' : ''}>
                                    ${configCampo.label}: <!-- üî• Usar label exacto para mapeo -->
                                </label>
                                <div class="variable-input-container">
                                    <input type="number" 
                                           id="${campoCompletoId}" 
                                           name="${campoCompletoId}"
                                           class="variable-input"
                                           ${configCampo.requerido ? 'required' : ''}
                                           min="0"
                                           step="${configCampo.step || '1'}"
                                           placeholder="${configCampo.placeholder}"
                                           value="${valorGuardado}"
                                           data-variable="${variableSeleccionada}"
                                           data-campo="${configCampo.label}"> <!-- üî• Guardar label para mapeo -->
                                    <span class="variable-unit">${configCampo.step === '0.01' ? (variableSeleccionada === 'Combustibles' ? 'Galones' : 'Gramos') : 'Unidades'}</span>
                                </div>
                                <div class="field-error" id="${campoCompletoId}Error">Este campo es requerido</div>
                            </div>
                        `;
                    }
                });
                
                camposHTML += '</div>';
                
                // Agregar informaci√≥n de c√°lculo autom√°tico
                if (configVariable.validaciones && configVariable.validaciones.length > 0) {
                    camposHTML += `
                        <div class="auto-calculation">
                            <h4>üìù Informaci√≥n de Validaci√≥n</h4>
                            <p>Los campos se validar√°n autom√°ticamente seg√∫n las siguientes reglas:</p>
                            <ul>
                                ${configVariable.validaciones.map(v => `<li>${v.descripcion}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            return camposHTML;
        }

        // ========== NUEVA FUNCI√ìN PARA GUARDAR DATOS DE LA VARIABLE ACTUAL ==========
        function guardarDatosVariableActual() {
            const variableActual = document.getElementById('variablesProductividad').value;
            
            if (!variableActual) return;
            
            const configVariable = variablesProductividad[variableActual];
            if (!configVariable) return;
            
            console.log('üíæ Guardando datos para variable:', variableActual);
            
            if (configVariable.tipo === 'numero' || configVariable.tipo === 'texto') {
                const fieldId = `valor_${variableActual.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const inputElement = document.getElementById(fieldId);
                
                if (inputElement) {
                    console.log(`  üíæ Guardando ${fieldId}: "${inputElement.value}"`);
                    datosVariablesGuardados[fieldId] = inputElement.value;
                }
            } else if (configVariable.tipo.startsWith('detalle_') && configVariable.campos) {
                Object.entries(configVariable.campos).forEach(([campoId, configCampo]) => {
                    const campoCompletoId = `${variableActual.replace(/[^a-zA-Z0-9]/g, '_')}_${campoId}`;
                    const inputElement = document.getElementById(campoCompletoId);
                    
                    if (inputElement) {
                        console.log(`  üíæ Guardando ${campoCompletoId}: "${inputElement.value}"`);
                        datosVariablesGuardados[campoCompletoId] = inputElement.value;
                    }
                });
            }
            
            console.log('üíæ Datos guardados actualmente:', datosVariablesGuardados);
        }

        // ========== FUNCI√ìN MODIFICADA PARA AGREGAR EVENT LISTENERS CON GUARDADO AUTOM√ÅTICO ==========
        function agregarEventListenersCamposDetallados(variableSeleccionada, configVariable) {
            if (configVariable.campos) {
                Object.entries(configVariable.campos).forEach(([campoId, configCampo]) => {
                    const campoCompletoId = `${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}_${campoId}`;
                    const inputElement = document.getElementById(campoCompletoId);
                    
                    if (inputElement) {
                        inputElement.addEventListener('input', function() {
                            validarCampoDetallado(this);
                            ejecutarValidacionesVariables(variableSeleccionada);
                            actualizarBarraProgreso();
                            
                            // üî• GUARDAR DATOS AUTOM√ÅTICAMENTE AL ESCRIBIR
                            datosVariablesGuardados[campoCompletoId] = this.value;
                            
                            // Si es la variable "Aprehendidos/Detenidos", gestionar detenidos
                            if (variableSeleccionada === "Aprehendidos/Detenidos") {
                                gestionarDetenidosSegunSuma();
                                gestionarRequeridosSegunValidacion();
                            }
                        });
                        
                        inputElement.addEventListener('blur', function() {
                            validarCampoDetallado(this);
                            ejecutarValidacionesVariables(variableSeleccionada);
                            actualizarBarraProgreso();
                            
                            // üî• GUARDAR DATOS AL PERDER EL FOCO TAMBI√âN
                            datosVariablesGuardados[campoCompletoId] = this.value;
                            
                            // Si es la variable "Aprehendidos/Detenidos", gestionar detenidos
                            if (variableSeleccionada === "Aprehendidos/Detenidos") {
                                gestionarDetenidosSegunSuma();
                                gestionarRequeridosSegunValidacion();
                            }
                        });
                    }
                });
            }
        }

        // ========== NUEVA FUNCI√ìN: GESTIONAR REQUERIDOS SEG√öN VALIDACI√ìN ==========
        function gestionarRequeridosSegunValidacion() {
            const variableSeleccionada = document.getElementById('variablesProductividad').value;
            
            if (variableSeleccionada !== "Aprehendidos/Detenidos") return;
            
            // Obtener elementos
            const campoHombres = document.getElementById('Aprehendidos_Detenidos_cantidad_hombres');
            const campoMujeres = document.getElementById('Aprehendidos_Detenidos_cantidad_mujeres');
            const campoAprehendidos = document.getElementById('Aprehendidos_Detenidos_cantidad_aprehendidos');
            const campoDetenidos = document.getElementById('Aprehendidos_Detenidos_cantidad_detenidos');
            
            if (!campoHombres || !campoMujeres) return;
            
            // Obtener valores
            const hombres = parseInt(campoHombres.value) || 0;
            const mujeres = parseInt(campoMujeres.value) || 0;
            const aprehendidos = parseInt(campoAprehendidos.value) || 0;
            const detenidos = parseInt(campoDetenidos.value) || 0;
            
            // Calcular sumas
            const sumaGeneros = hombres + mujeres;
            const sumaAprehendidosDetenidos = aprehendidos + detenidos;
            
            // Verificar si la validaci√≥n se cumple
            const validacionCumplida = (sumaGeneros === sumaAprehendidosDetenidos);
            
            // Quitar/poner requerido seg√∫n validaci√≥n
            campoHombres.required = !validacionCumplida;
            campoMujeres.required = !validacionCumplida;
            
            // Actualizar estilos visuales
            if (validacionCumplida) {
                campoHombres.classList.remove('invalid');
                campoMujeres.classList.remove('invalid');
                
                // Ocultar mensajes de error
                const errorHombres = document.getElementById('Aprehendidos_Detenidos_cantidad_hombresError');
                const errorMujeres = document.getElementById('Aprehendidos_Detenidos_cantidad_mujeresError');
                if (errorHombres) errorHombres.style.display = 'none';
                if (errorMujeres) errorMujeres.style.display = 'none';
                
                console.log('‚úÖ Validaci√≥n cumplida - Campos de g√©nero NO requeridos');
            } else {
                console.log('‚ö†Ô∏è Validaci√≥n NO cumplida - Campos de g√©nero S√ç requeridos');
            }
        }

        // ========== FUNCI√ìN PARA GESTIONAR DETENIDOS SEG√öN SUMA ==========
        function gestionarDetenidosSegunSuma() {
            const variableSeleccionada = document.getElementById('variablesProductividad').value;
            
            // Solo proceder si la variable seleccionada es "Aprehendidos/Detenidos"
            if (variableSeleccionada !== "Aprehendidos/Detenidos") {
                return;
            }
            
            // Obtener valores de los campos
            const cantidadAprehendidos = parseInt(document.getElementById('Aprehendidos_Detenidos_cantidad_aprehendidos').value) || 0;
            const cantidadDetenidos = parseInt(document.getElementById('Aprehendidos_Detenidos_cantidad_detenidos').value) || 0;
            
            // Calcular suma total
            const totalDetenidos = cantidadAprehendidos + cantidadDetenidos;
            
            // Mostrar u ocultar secci√≥n de detenidos
            const seccionDetenidos = document.getElementById('seccionDetenidos');
            
            if (totalDetenidos > 0) {
                seccionDetenidos.style.display = 'block';
                
                // Ajustar el n√∫mero de formularios de detenidos seg√∫n la suma
                ajustarFormulariosDetenidos(totalDetenidos);
                
                // Hacer scroll a la secci√≥n de detenidos
                setTimeout(() => {
                    seccionDetenidos.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
                mostrarNotificacion(`Se han activado ${totalDetenidos} formulario(s) de detenido(s)`, 'info', 3000);
            } else {
                seccionDetenidos.style.display = 'none';
                // Limpiar todos los detenidos si la suma es 0
                document.getElementById('detenidosContainer').innerHTML = '';
                detenidoCount = 0;
                actualizarContadorDetenidos();
            }
            
            actualizarBarraProgreso();
        }

        function ajustarFormulariosDetenidos(totalRequerido) {
            const container = document.getElementById('detenidosContainer');
            const detenidosActuales = container.querySelectorAll('.detenido-container').length;
            
            // Si necesitamos m√°s detenidos de los que hay actualmente
            if (totalRequerido > detenidosActuales) {
                const cantidadAAgregar = totalRequerido - detenidosActuales;
                for (let i = 0; i < cantidadAAgregar; i++) {
                    agregarDetenido();
                }
            }
            // Si necesitamos menos detenidos de los que hay actualmente
            else if (totalRequerido < detenidosActuales) {
                const cantidadAEliminar = detenidosActuales - totalRequerido;
                for (let i = 0; i < cantidadAEliminar; i++) {
                    const idAEliminar = detenidoCount;
                    eliminarDetenido(idAEliminar);
                }
            }
            
            // Deshabilitar el bot√≥n de agregar detenido manualmente
            // NOTA: El bot√≥n ya fue eliminado, pero mantenemos la l√≥gica por si acaso
            const btnAgregar = document.getElementById('btnAgregarDetenido');
            if (btnAgregar) {
                btnAgregar.disabled = true;
                btnAgregar.style.opacity = '0.5';
                btnAgregar.style.cursor = 'not-allowed';
            }
            
            // Actualizar el texto del contador
            document.getElementById('totalDetenidos').textContent = totalRequerido;
        }

        function validarCampoDetallado(inputElement) {
            const errorElement = document.getElementById(inputElement.id + 'Error');
            const valor = inputElement.value.trim();
            const esRequerido = inputElement.hasAttribute('required');
            
            let esValido = true;
            
            if (esRequerido && !valor) {
                esValido = false;
            } else if (valor && inputElement.type === 'number') {
                const numero = parseFloat(valor);
                if (isNaN(numero) || numero < 0) {
                    esValido = false;
                }
            }
            
            if (esValido) {
                inputElement.classList.remove('invalid');
                inputElement.classList.add('valid');
                if (errorElement) errorElement.style.display = 'none';
            } else {
                inputElement.classList.remove('valid');
                inputElement.classList.add('invalid');
                if (errorElement) errorElement.style.display = 'block';
            }
            
            return esValido;
        }

        function validarVariableProductividad(inputElement) {
            const errorElement = document.getElementById(inputElement.id + 'Error');
            const valor = inputElement.value.trim();
            const configVariable = variablesProductividad[inputElement.dataset.variable];
            
            if (!configVariable) return false;
            
            let esValido = true;
            
            if (configVariable.requerido && !valor) {
                esValido = false;
            } else if (configVariable.tipo === 'numero' && valor) {
                const numero = parseFloat(valor);
                if (isNaN(numero) || numero < 0) {
                    esValido = false;
                }
                if (configVariable.min && numero < parseFloat(configVariable.min)) {
                    esValido = false;
                }
                if (configVariable.max && numero > parseFloat(configVariable.max)) {
                    esValido = false;
                }
            }
            
            if (esValido) {
                inputElement.classList.remove('invalid');
                inputElement.classList.add('valid');
                if (errorElement) errorElement.style.display = 'none';
            } else {
                inputElement.classList.remove('valid');
                inputElement.classList.add('invalid');
                if (errorElement) errorElement.style.display = 'block';
            }
            
            return esValido;
        }

        function ejecutarValidacionesVariables(variableSeleccionada) {
            const configVariable = variablesProductividad[variableSeleccionada];
            const validationSummary = document.getElementById('validationSummary');
            const validationSummaryContent = document.getElementById('validationSummaryContent');
            
            if (!configVariable || !configVariable.validaciones) {
                validationSummary.style.display = 'none';
                return true;
            }
            
            // Obtener valores de todos los campos
            const valoresCampos = {};
            Object.keys(configVariable.campos).forEach(campoId => {
                const campoCompletoId = `${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}_${campoId}`;
                const inputElement = document.getElementById(campoCompletoId);
                if (inputElement) {
                    valoresCampos[campoId] = inputElement.value;
                }
            });
            
            // Ejecutar validaciones
            let todasValidas = true;
            let htmlValidaciones = '';
            
            configVariable.validaciones.forEach(validacion => {
                const esValida = validacion.validar(valoresCampos);
                todasValidas = todasValidas && esValida;
                
                htmlValidaciones += `
                    <div class="validation-summary-item ${esValida ? 'valid' : 'invalid'}">
                        ${esValida ? '‚úÖ' : '‚ùå'} ${validacion.descripcion}
                    </div>
                `;
            });
            
            // Mostrar resumen de validaciones
            validationSummaryContent.innerHTML = htmlValidaciones;
            validationSummary.style.display = 'block';
            validationSummary.className = `validation-summary ${todasValidas ? 'success' : 'error'}`;
            
            return todasValidas;
        }

        function validarTodasVariablesProductividad() {
            const variableSeleccionada = document.getElementById('variablesProductividad').value;
            if (!variableSeleccionada) {
                mostrarNotificacion('‚ùå Debe seleccionar una variable de productividad', 'error', 5000);
                return false;
            }
            
            const configVariable = variablesProductividad[variableSeleccionada];
            
            if (configVariable.tipo === 'numero' || configVariable.tipo === 'texto') {
                const fieldId = `valor_${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const inputElement = document.getElementById(fieldId);
                
                if (inputElement) {
                    return validarVariableProductividad(inputElement);
                }
            } else if (configVariable.tipo.startsWith('detalle_')) {
                // Validar todos los campos detallados
                if (configVariable.campos) {
                    let todosValidos = true;
                    Object.entries(configVariable.campos).forEach(([campoId, configCampo]) => {
                        const campoCompletoId = `${variableSeleccionada.replace(/[^a-zA-Z0-9]/g, '_')}_${campoId}`;
                        const inputElement = document.getElementById(campoCompletoId);
                        
                        if (inputElement && configCampo.requerido) {
                            if (!validarCampoDetallado(inputElement)) {
                                todosValidos = false;
                            }
                        }
                    });
                    
                    // Ejecutar validaciones espec√≠ficas
                    const validacionesValidas = ejecutarValidacionesVariables(variableSeleccionada);
                    
                    return todosValidos && validacionesValidas;
                }
            }
            
            return false;
        }

        // ========== FUNCIONES PARA DETENIDOS ==========
        function agregarDetenido() {
            detenidoCount++;
            const container = document.getElementById('detenidosContainer');
            
            const detenidoDiv = document.createElement('div');
            detenidoDiv.className = 'detenido-container';
            detenidoDiv.id = `detenido-${detenidoCount}`;
            
            detenidoDiv.innerHTML = `
                <div class="detenido-header">
                    <div class="detenido-title">
                        <span class="detenido-count">${detenidoCount}</span>
                        Detenido #${detenidoCount}
                    </div>
                    <button type="button" class="remove-detenido" data-id="${detenidoCount}" style="display: none;">√ó</button>
                </div>
                
                <div class="form-grid">
                    <div class="form-group form-group-full">
                        <label for="nombresDetenido-${detenidoCount}" class="required">Apellidos y Nombres del Detenido:</label>
                        <input type="text" id="nombresDetenido-${detenidoCount}" name="nombresDetenido-${detenidoCount}" 
                               placeholder="Ej: PEREZ GONZALEZ JUAN CARLOS" required>
                        <div class="field-error" id="nombresDetenidoError-${detenidoCount}">Este campo es requerido</div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cedulaDetenido-${detenidoCount}" class="required">C√©dula/Pasaporte del Detenido:</label>
                        <input type="text" id="cedulaDetenido-${detenidoCount}" name="cedulaDetenido-${detenidoCount}" 
                               placeholder="Ej: 1234567890 o AB123456" required>
                        <div class="field-error" id="cedulaDetenidoError-${detenidoCount}">Este campo es requerido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edadDetenido-${detenidoCount}" class="required">Edad del Detenido:</label>
                        <input type="number" id="edadDetenido-${detenidoCount}" name="edadDetenido-${detenidoCount}" 
                               min="1" max="120" placeholder="Ej: 25" required>
                        <div class="field-error" id="edadDetenidoError-${detenidoCount}">La edad debe estar entre 1 y 120 a√±os</div>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nacionalidadDetenido-${detenidoCount}" class="required">Nacionalidad del Detenido:</label>
                        <input type="text" id="nacionalidadDetenido-${detenidoCount}" name="nacionalidadDetenido-${detenidoCount}" 
                               list="nacionalidadesList" placeholder="Ej: ECUATORIANA" required>
                        <datalist id="nacionalidadesList">
                            ${nacionalidades.map(n => `<option value="${n}">`).join('')}
                        </datalist>
                        <div class="field-error" id="nacionalidadDetenidoError-${detenidoCount}">Este campo es requerido</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cantidadDetenciones-${detenidoCount}">Cantidad de Detenciones del Detenido:</label>
                        <input type="number" id="cantidadDetenciones-${detenidoCount}" name="cantidadDetenciones-${detenidoCount}" 
                               min="0" placeholder="Ej: 2">
                        <small class="small-hint">Dejar en 0 si es la primera detenci√≥n</small>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="resolucionFlagrancia-${detenidoCount}">Resoluci√≥n de la Flagrancia del Detenido:</label>
                        <select id="resolucionFlagrancia-${detenidoCount}" name="resolucionFlagrancia-${detenidoCount}">
                            <option value="">Seleccione una resoluci√≥n...</option>
                            ${resolucionesFlagrancia.map(resolucion => `<option value="${resolucion}">${resolucion}</option>`).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="grupoDelictivo-${detenidoCount}">Grupo Delictivo al que Pertenece el Detenido:</label>
                        <select id="grupoDelictivo-${detenidoCount}" name="grupoDelictivo-${detenidoCount}">
                            <option value="">Seleccione un grupo...</option>
                            ${gruposDelictivos.map(g => `<option value="${g}">${g}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="servidorPolicial-${detenidoCount}">¬øEl Detenido es Servidor Policial?</label>
                        <select id="servidorPolicial-${detenidoCount}" name="servidorPolicial-${detenidoCount}">
                            <option value="">Seleccione...</option>
                            <option value="SI">S√ç</option>
                            <option value="NO">NO</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(detenidoDiv);
            actualizarContadorDetenidos();
            
            // Agregar event listeners para validaci√≥n
            agregarEventListenersDetenido(detenidoCount);
            
            // Hacer scroll al nuevo detenido
            setTimeout(() => {
                detenidoDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Funci√≥n para agregar event listeners a un detenido
        function agregarEventListenersDetenido(id) {
            const nombresInput = document.getElementById(`nombresDetenido-${id}`);
            const cedulaInput = document.getElementById(`cedulaDetenido-${id}`);
            const edadInput = document.getElementById(`edadDetenido-${id}`);
            const nacionalidadInput = document.getElementById(`nacionalidadDetenido-${id}`);
            
            nombresInput.addEventListener('blur', () => validarCampoRequerido(nombresInput, id, 'nombresDetenido'));
            cedulaInput.addEventListener('blur', () => validarCampoRequerido(cedulaInput, id, 'cedulaDetenido'));
            edadInput.addEventListener('blur', () => validarEdad(edadInput, id));
            nacionalidadInput.addEventListener('blur', () => validarCampoRequerido(nacionalidadInput, id, 'nacionalidadDetenido'));
            
            // Convertir a may√∫sculas mientras se escribe
            nombresInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            
            nacionalidadInput.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }

        // Funci√≥n para validar campos requeridos
        function validarCampoRequerido(campo, id, tipo) {
            const errorElement = document.getElementById(`${tipo}Error-${id}`);
            
            if (campo.value.trim() === '') {
                campo.classList.remove('valid');
                campo.classList.add('invalid');
                errorElement.style.display = 'block';
                return false;
            } else {
                campo.classList.remove('invalid');
                campo.classList.add('valid');
                errorElement.style.display = 'none';
                return true;
            }
        }

        // Funci√≥n para validar edad
        function validarEdad(campo, id) {
            const errorElement = document.getElementById(`edadDetenidoError-${id}`);
            const edad = parseInt(campo.value);
            
            if (isNaN(edad) || edad < 1 || edad > 120) {
                campo.classList.remove('valid');
                campo.classList.add('invalid');
                errorElement.style.display = 'block';
                return false;
            } else {
                campo.classList.remove('invalid');
                campo.classList.add('valid');
                errorElement.style.display = 'none';
                return true;
            }
        }

        // Funci√≥n para eliminar un detenido
        function eliminarDetenido(id) {
            const detenidoDiv = document.getElementById(`detenido-${id}`);
            if (detenidoDiv) {
                detenidoDiv.remove();
                actualizarContadorDetenidos();
                mostrarNotificacion(`Detenido #${id} eliminado`, 'info', 3000);
            }
        }

        // Funci√≥n para actualizar el contador de detenidos
        function actualizarContadorDetenidos() {
            const contenedores = document.querySelectorAll('.detenido-container');
            document.getElementById('totalDetenidos').textContent = contenedores.length;
            
            // Actualizar n√∫meros de detenidos
            contenedores.forEach((contenedor, index) => {
                const countSpan = contenedor.querySelector('.detenido-count');
                const titleSpan = contenedor.querySelector('.detenido-title');
                
                if (countSpan) countSpan.textContent = index + 1;
                if (titleSpan) {
                    titleSpan.innerHTML = `<span class="detenido-count">${index + 1}</span> Detenido #${index + 1}`;
                }
            });
        }

        // Funci√≥n para validar todos los detenidos
        function validarTodosDetenidos() {
            if (detenidoCount === 0) {
                return true; // No hay detenidos, pero no es un error
            }
            
            let todosValidos = true;
            
            for (let i = 1; i <= detenidoCount; i++) {
                const detenidoDiv = document.getElementById(`detenido-${i}`);
                if (!detenidoDiv) continue;
                
                const nombres = document.getElementById(`nombresDetenido-${i}`);
                const cedula = document.getElementById(`cedulaDetenido-${i}`);
                const edad = document.getElementById(`edadDetenido-${i}`);
                const nacionalidad = document.getElementById(`nacionalidadDetenido-${i}`);
                
                if (nombres && !validarCampoRequerido(nombres, i, 'nombresDetenido')) {
                    todosValidos = false;
                }
                
                if (cedula && !validarCampoRequerido(cedula, i, 'cedulaDetenido')) {
                    todosValidos = false;
                }
                
                if (edad && !validarEdad(edad, i)) {
                    todosValidos = false;
                }
                
                if (nacionalidad && !validarCampoRequerido(nacionalidad, i, 'nacionalidadDetenido')) {
                    todosValidos = false;
                }
            }
            
            return todosValidos;
        }

        // ========== FUNCIONES AUXILIARES ==========
        function actualizarUnidades() {
            const direccion = document.getElementById('direccionInterventora').value;
            const unidadSelect = document.getElementById('unidadInterventora');
            const unidadesStatus = document.getElementById('unidadesStatus');
            
            unidadSelect.innerHTML = '';
            unidadSelect.disabled = true;
            
            if (!direccion) {
                unidadSelect.innerHTML = '<option value="">Primero seleccione una direcci√≥n...</option>';
                unidadesStatus.textContent = '';
                return;
            }
            
            const unidades = datosUnidades[direccion];
            
            if (unidades && unidades.length > 0) {
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `Seleccione una unidad de ${direccion}...`;
                unidadSelect.appendChild(defaultOption);
                
                unidades.forEach((unidad) => {
                    const option = document.createElement('option');
                    option.value = unidad;
                    option.textContent = unidad;
                    unidadSelect.appendChild(option);
                });
                
                unidadSelect.disabled = false;
                unidadesStatus.textContent = `‚úì ${unidades.length} unidades disponibles`;
                unidadesStatus.className = 'data-status success';
            } else {
                unidadSelect.innerHTML = '<option value="">No hay unidades disponibles para esta direcci√≥n</option>';
                unidadesStatus.textContent = `‚úó No se encontraron unidades para ${direccion}`;
                unidadesStatus.className = 'data-status error';
            }
            
            actualizarBarraProgreso();
        }

        function validarCampo(campo, errorElement) {
            const valor = campo.value.trim();
            
            if (campo.validity.valid && valor !== '') {
                campo.classList.remove('invalid');
                campo.classList.add('valid');
                if (errorElement) errorElement.style.display = 'none';
                return true;
            } else {
                campo.classList.remove('valid');
                campo.classList.add('invalid');
                if (errorElement) errorElement.style.display = 'block';
                return false;
            }
        }

        // ========== BUSQUEDA DE DATOS POR C√âDULA ==========
        async function buscarPorCedula(cedula) {
            const cedulaStatus = document.getElementById('cedulaStatus');
            const loadingIcon = document.querySelector('.cedula-loading');
            
            if (cedula.length !== 10 || !/^\d{10}$/.test(cedula)) {
                cedulaStatus.textContent = 'Ingrese una c√©dula v√°lida de 10 d√≠gitos';
                cedulaStatus.className = 'data-status error';
                return;
            }
            
            loadingIcon.classList.add('active');
            cedulaStatus.textContent = 'Buscando datos del funcionario...';
            cedulaStatus.className = 'data-status loading';
            
            // Limpiar campos primero
            document.getElementById('grado').value = '';
            document.getElementById('apellidosNombres').value = '';
            document.getElementById('celular').value = '';
            document.getElementById('correoElectronico').value = '';
            
            document.getElementById('grado').classList.remove('auto-filled');
            document.getElementById('apellidosNombres').classList.remove('auto-filled');
            document.getElementById('celular').classList.remove('auto-filled');
            document.getElementById('correoElectronico').classList.remove('auto-filled');
            
            try {
                console.log('üîç Buscando datos para c√©dula:', cedula);
                
                // Usar la URL √∫nica con par√°metro action
                const url = `${APPS_SCRIPT_URL}?action=buscar_cedula&cedula=${cedula}&timestamp=${Date.now()}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Respuesta del servidor:', data);
                    
                    if (data.success) {
                        // Usar los campos seg√∫n la estructura del nuevo script
                        const grado = data.grado || '';
                        const nombres = data.nombres || '';
                        const celular = data.celular || '';
                        const correo = data.correo || '';
                        
                        console.log('‚úÖ Datos obtenidos:', { grado, nombres, celular, correo });
                        
                        // Actualizar campos del formulario
                        document.getElementById('grado').value = grado;
                        document.getElementById('apellidosNombres').value = nombres;
                        document.getElementById('celular').value = celular;
                        document.getElementById('correoElectronico').value = correo;
                        
                        // Aplicar estilos de campos auto-llenados
                        document.getElementById('grado').classList.add('auto-filled');
                        document.getElementById('apellidosNombres').classList.add('auto-filled');
                        document.getElementById('celular').classList.add('auto-filled');
                        document.getElementById('correoElectronico').classList.add('auto-filled');
                        
                        // Validar campos
                        validarCampo(document.getElementById('grado'), document.getElementById('gradoError'));
                        validarCampo(document.getElementById('apellidosNombres'), document.getElementById('nombresError'));
                        validarCampo(document.getElementById('celular'), document.getElementById('celularError'));
                        validarCampo(document.getElementById('correoElectronico'), document.getElementById('correoError'));
                        
                        cedulaStatus.textContent = '‚úì Datos del funcionario cargados correctamente';
                        cedulaStatus.className = 'data-status success';
                        actualizarBarraProgreso();
                        
                        // Mostrar notificaci√≥n de √©xito
                        mostrarNotificacion(`Datos de ${nombres} cargados correctamente`, 'success', 3000);
                        
                    } else {
                        const mensajeError = data.message || 'No se encontr√≥ el funcionario';
                        cedulaStatus.textContent = '‚úó ' + mensajeError;
                        cedulaStatus.className = 'data-status error';
                        mostrarNotificacion(mensajeError, 'error', 4000);
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                cedulaStatus.textContent = '‚úó Error de conexi√≥n con el servidor';
                cedulaStatus.className = 'data-status error';
                mostrarNotificacion('Error al conectar con el servidor. Verifique su conexi√≥n.', 'error', 4000);
            } finally {
                loadingIcon.classList.remove('active');
            }
        }

        function validarCedula() {
            const cedula = document.getElementById('numeroCedula');
            const error = document.getElementById('cedulaError');
            const valor = cedula.value.trim();
            
            if (/^\d{10}$/.test(valor)) {
                cedula.classList.remove('invalid');
                cedula.classList.add('valid');
                error.style.display = 'none';
                
                clearTimeout(window.cedulaTimeout);
                window.cedulaTimeout = setTimeout(() => buscarPorCedula(valor), 800);
                return true;
            } else {
                cedula.classList.remove('valid');
                cedula.classList.add('invalid');
                error.style.display = 'block';
                document.getElementById('cedulaStatus').textContent = '';
                return false;
            }
        }

        // ========== BUSQUEDA DE DATOS DE SUBCIRCUITO ==========
        async function buscarSubcircuito(codigo) {
            const dataStatus = document.getElementById('dataStatus');
            const codigoBuscado = codigo.toUpperCase().trim();
            
            if (!codigoBuscado) {
                dataStatus.textContent = '';
                return;
            }
            
            dataStatus.textContent = 'Buscando subcircuito...';
            dataStatus.className = 'data-status loading';
            
            try {
                console.log('üîç Buscando subcircuito:', codigoBuscado);
                
                // Usar la URL √∫nica con par√°metro action
                const url = `${APPS_SCRIPT_URL}?action=buscar_subcircuito&codigo=${codigoBuscado}&timestamp=${Date.now()}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üìä Respuesta del servidor:', data);
                    
                    if (data.success && data.data) {
                        document.getElementById('zona').value = data.data.zona || '';
                        document.getElementById('subzona').value = data.data.subzona || '';
                        document.getElementById('distrito').value = data.data.distrito || '';
                        document.getElementById('circuito').value = data.data.circuito || '';
                        document.getElementById('subcircuito').value = data.data.subcircuito || '';
                        
                        dataStatus.textContent = '‚úì Datos cargados correctamente';
                        dataStatus.className = 'data-status success';
                        actualizarBarraProgreso();
                        return;
                    } else {
                        dataStatus.textContent = data.message || '‚úó C√≥digo no encontrado';
                        dataStatus.className = 'data-status error';
                    }
                } else {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error en b√∫squeda de subcircuito:', error);
                dataStatus.textContent = '‚úó Error de conexi√≥n con el servidor';
                dataStatus.className = 'data-status error';
            }
        }

        // ========== B√öSQUEDA DE DELITOS ==========
        function buscarDelitos(termino) {
            const delitoInput = document.getElementById('presuntoDelito');
            const resultados = document.getElementById('delitoSearchResults');
            
            resultados.innerHTML = '';
            
            if (!termino || termino.length < 2) {
                resultados.style.display = 'none';
                return;
            }
            
            const terminoBusqueda = termino.toUpperCase();
            const delitosFiltrados = listaDelitos.filter(delito => 
                delito.includes(terminoBusqueda)
            ).slice(0, 10);
            
            if (delitosFiltrados.length === 0) {
                resultados.style.display = 'none';
                return;
            }
            
            delitosFiltrados.forEach(delito => {
                const div = document.createElement('div');
                div.className = 'delito-search-result';
                div.textContent = delito;
                div.addEventListener('click', function() {
                    delitoInput.value = delito;
                    resultados.style.display = 'none';
                    validarDelito();
                });
                resultados.appendChild(div);
            });
            
            resultados.style.display = 'block';
        }

        function validarDelito() {
            const delitoInput = document.getElementById('presuntoDelito');
            const delitoError = document.getElementById('delitoError');
            
            if (delitoInput.value && listaDelitos.includes(delitoInput.value.toUpperCase())) {
                delitoError.style.display = 'none';
                delitoInput.classList.remove('invalid');
                delitoInput.classList.add('valid');
                return true;
            } else {
                delitoError.style.display = 'block';
                delitoInput.classList.remove('valid');
                delitoInput.classList.add('invalid');
                return false;
            }
        }

        // ========== OBTENER UBICACI√ìN ==========
        function obtenerUbicacion() {
            const locationStatus = document.getElementById('locationStatus');
            const latitud = document.getElementById('latitud');
            const longitud = document.getElementById('longitud');
            const permissionHelp = document.getElementById('permissionHelp');
            
            locationStatus.innerHTML = '<span class="location-loading">üîÑ Obteniendo ubicaci√≥n...</span>';
            permissionHelp.style.display = 'none';
            
            if (!navigator.geolocation) {
                locationStatus.innerHTML = '<span class="location-error">‚ùå La geolocalizaci√≥n no es compatible con este navegador</span>';
                permissionHelp.style.display = 'block';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latitud.value = lat.toString().replace('.', ',');
                    longitud.value = lng.toString().replace('.', ',');
                    
                    locationStatus.innerHTML = '<span class="location-success">‚úÖ Ubicaci√≥n obtenida correctamente</span>';
                    validarCoordenadas();
                    actualizarBarraProgreso();
                    
                    // Obtener direcci√≥n autom√°ticamente
                    obtenerDireccionDesdeCoordenadas(lat, lng);
                },
                function(error) {
                    let mensaje = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensaje = '‚ùå Permiso de ubicaci√≥n denegado';
                            permissionHelp.style.display = 'block';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensaje = '‚ùå Informaci√≥n de ubicaci√≥n no disponible';
                            permissionHelp.style.display = 'block';
                            break;
                        case error.TIMEOUT:
                            mensaje = '‚ùå Tiempo de espera agotado para obtener ubicaci√≥n';
                            break;
                        default:
                            mensaje = '‚ùå Error desconocido al obtener ubicaci√≥n';
                    }
                    locationStatus.innerHTML = `<span class="location-error">${mensaje}</span>`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // ========== VALIDACI√ìN DE COORDENADAS ==========
        function validarCoordenadas() {
            const latitud = document.getElementById('latitud');
            const longitud = document.getElementById('longitud');
            const latitudError = document.getElementById('latitudError');
            const longitudError = document.getElementById('longitudError');
            
            const patronLatitud = /^-?\d{1,2},\d+$/;
            const patronLongitud = /^-?\d{1,3},\d+$/;
            
            let valido = true;
            
            if (patronLatitud.test(latitud.value)) {
                latitud.classList.remove('invalid');
                latitud.classList.add('valid');
                latitudError.style.display = 'none';
            } else {
                latitud.classList.remove('valid');
                latitud.classList.add('invalid');
                latitudError.style.display = 'block';
                valido = false;
            }
            
            if (patronLongitud.test(longitud.value)) {
                longitud.classList.remove('invalid');
                longitud.classList.add('valid');
                longitudError.style.display = 'none';
            } else {
                longitud.classList.remove('valid');
                longitud.classList.add('invalid');
                longitudError.style.display = 'block';
                valido = false;
            }
            
            return valido;
        }

        function actualizarBarraProgreso() {
            const camposRequeridos = document.querySelectorAll('input[required], select[required], textarea[required]');
            const camposCompletados = Array.from(camposRequeridos).filter(campo => 
                campo.value.trim() !== '' && campo.validity.valid
            ).length;
            
            const variableSeleccionada = document.getElementById('variablesProductividad').value;
            let validacionesValidas = true;
            
            if (variableSeleccionada) {
                validacionesValidas = ejecutarValidacionesVariables(variableSeleccionada);
            }
            
            const progreso = (camposCompletados / camposRequeridos.length) * 100;
            document.getElementById('progressBar').style.width = `${progreso}%`;
            
            // Cambiar color seg√∫n estado de validaciones
            if (progreso === 100 && validacionesValidas) {
                document.getElementById('progressBar').style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            } else if (progreso === 100 && !validacionesValidas) {
                document.getElementById('progressBar').style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            } else {
                document.getElementById('progressBar').style.background = 'linear-gradient(135deg, #2a5298, #667eea)';
            }
        }

        function limpiarFormulario() {
            document.getElementById('operativeForm').reset();
            document.getElementById('variableSectionsContainer').innerHTML = '';
            document.getElementById('validationSummary').style.display = 'none';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').style.background = 'linear-gradient(135deg, #2a5298, #667eea)';
            
            // Limpiar campos de solo lectura
            document.querySelectorAll('.readonly').forEach(campo => {
                campo.value = '';
                campo.classList.remove('auto-filled');
            });
            
            // Limpiar estados
            document.getElementById('unidadesStatus').textContent = '';
            document.getElementById('dataStatus').textContent = '';
            document.getElementById('cedulaStatus').textContent = '';
            document.getElementById('locationStatus').textContent = '';
            
            // Limpiar detenidos
            document.getElementById('detenidosContainer').innerHTML = '';
            detenidoCount = 0;
            actualizarContadorDetenidos();
            
            // Ocultar secci√≥n de detenidos
            document.getElementById('seccionDetenidos').style.display = 'none';
            
            mostrarNotificacion('Formulario limpiado correctamente', 'info', 3000);
        }

        // ========== MODIFICACI√ìN: FUNCI√ìN ACTUALIZADA PARA GESTI√ìN DE INDICADORES ADICIONALES ==========
        function gestionarIndicadoresAdicionales() {
            const nivelIndicadores = document.getElementById('nivelIndicadores').value;
            const seccionIndicadoresAdicionales = document.getElementById('indicadoresAdicionales');
            const seccionResponsable = document.getElementById('seccionResponsable');
            const seccionVariablesProductividad = document.getElementById('seccionVariablesProductividad');
            
            // Ocultar todas las secciones primero
            seccionIndicadoresAdicionales.classList.remove('active');
            seccionResponsable.style.display = 'none';
            
            if (nivelIndicadores === 'SI') {
                // Mostrar indicadores adicionales
                seccionIndicadoresAdicionales.classList.add('active');
                
                // MODIFICACI√ìN: Hacer scroll a la secci√≥n de Variables de Productividad OBLIGATORIAMENTE
                setTimeout(() => {
                    seccionVariablesProductividad.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    
                    // Resaltar la secci√≥n para mayor visibilidad
                    seccionVariablesProductividad.style.border = '3px solid #28a745';
                    seccionVariablesProductividad.style.boxShadow = '0 0 15px rgba(40, 167, 69, 0.5)';
                    
                    // Quitar el resaltado despu√©s de 3 segundos
                    setTimeout(() => {
                        seccionVariablesProductividad.style.border = '';
                        seccionVariablesProductividad.style.boxShadow = '';
                    }, 3000);
                    
                }, 300);
                
                // Mostrar notificaci√≥n informativa
                mostrarNotificacion('Se han habilitado los indicadores adicionales. Por favor, complete la secci√≥n de Variables de Productividad.', 'info', 5000);
                
            } else if (nivelIndicadores === 'NO') {
                // Ocultar indicadores adicionales y mostrar responsable
                seccionIndicadoresAdicionales.classList.remove('active');
                seccionResponsable.style.display = 'block';
                
                // Hacer scroll a la secci√≥n del responsable
                setTimeout(() => {
                    seccionResponsable.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
                
                mostrarNotificacion('Se ha habilitado la secci√≥n del responsable', 'info', 3000);
            } else {
                // Si no se selecciona nada, mantener ocultas ambas secciones
                seccionIndicadoresAdicionales.classList.remove('active');
                seccionResponsable.style.display = 'none';
            }
            
            actualizarBarraProgreso();
        }

        // ========== FUNCI√ìN MODIFICADA PARA ENVIAR TODOS LOS DATOS GUARDADOS ==========
        function diagnosticarMapeoVariables() {
            console.log('üîç ========== INICIANDO DIAGN√ìSTICO COMPLETO ==========');
            
            const tablaVariables = {};
            
            console.log('üíæ Datos guardados disponibles:', datosVariablesGuardados);
            
            // INICIALIZAR TODAS LAS VARIABLES EN 0 O CADENA VAC√çA
            const todasVariables = [
                "Aeronaves (Und)", "Allanamientos", "Aprehendidos/Detenidos", "Armas de Fuego",
                "Auditorias de Seguridad", "Autopartes y Autopartes de Vehiculos", "Bienes Inmuebles Incautados",
                "Cantidad Personas Desaparecidas Localizadas", "Cap_Detonantes (Und)", "Celulares (Und)",
                "Certificado de Armas Entregado", "Cloruro de Calcio (Kg)", "Coincidencias Potenciales de Vainas",
                "Coordinacion con Upc", "Combustibles", "Coordinaciones Realizadas", "Deposito de Dinero Real",
                "Destiladores", "Destruccion de Dinero Falso", "Dinero en Cuentas Bancarias ($)",
                "Disposicion Final de Armas de Fuego", "Disposicion Final de Automotores",
                "Disposicion Final de Bienes Muebles E Inmuebles", "Disposicion Final de Municiones",
                "Dolares Americanos ($)", "Dolares Falsos ($)", "Drogas", "Embarcaciones (Und)",
                "Fauna Silvestre (Und)", "Fulminantes (Und)", "Glp (15 - 45 Kg) (Und)", "Granadas (Und)",
                "Indique El Porcentaje de Cumplimiento de La Investigacion Previa (%)",
                "Informacion Relevante (Sms-Audios)", "Informes de Analisis", "Investigaciones Previas Aperturadas",
                "Laboratorio_Procesamiento_Droga", "Madera (M3)", "Maquinaria Pesada (Und)", "Material Aurifero (Kg)",
                "Mecha Lenta Cordon Detonante (Metros)", "Minas Detonantes (Und)", "Motores F. Borda (Und)",
                "Municiones (Und)", "Ni√±os, Ni√±as y Adolescentes Rescatados", "Nitrato de Amonio (Kg)",
                "Numero de La Investigacion Previa Aperturada", "Operativos de Traslado",
                "Ordenes Judiciales de Analisis Telefonico Cumplidas", "Patrimonio Cultural (Und)", "Pentolita (Kg)",
                "Perdigones (Und)", "Perforaciones", "Pericias Accidentologia Vial", "Pericias Criminalistica",
                "Pericias Medicina Legal", "Personas Protegidas", "Pirotecnia (Und)", "Piscinas Artesanales de Cldh",
                "Polvora (Kg)", "Productos Agricolas (Bultos)", "Quimicos Liquidos (Lt)", "Quimicos Solidos (Kg)",
                "Registro de Medidas Cautelares", "Reportes Telefonicos Entregados", "Semovientes (Und)",
                "Subzonas Intervenidas", "Tacos de Dinamita (Und)", "Traslado de Indicios Bajo Pedido de Autoridad Competente",
                "Valor de los Bienes Inmuebles Incautados", "Veh√≠culos", "Victimas Liberadas", "V√≠ctimas Rescatadas", "Varios"
            ];

            console.log(`üìã Total de variables en el sistema: ${todasVariables.length}`);

            // Inicializar todas las variables con valores por defecto
            todasVariables.forEach(variable => {
                if (variable === "Numero de La Investigacion Previa Aperturada" || variable === "Varios") {
                    tablaVariables[variable] = '';
                } else {
                    tablaVariables[variable] = '0';
                }
            });

            console.log('‚úÖ Todas las variables inicializadas con valores por defecto');

            // üî• CORRECCI√ìN CR√çTICA: MAPEAR LOS NOMBRES CORRECTAMENTE
            console.log('üîç CORRIGIENDO MAPEO DE NOMBRES...');
            
            Object.keys(datosVariablesGuardados).forEach(key => {
                if (datosVariablesGuardados[key] !== '' && datosVariablesGuardados[key] !== undefined) {
                    
                    // üî• CORREGIR: Si la clave empieza con "valor_", extraer el nombre real de la variable
                    if (key.startsWith('valor_')) {
                        // Extraer el nombre real de la variable
                        let nombreReal = key.replace('valor_', '');
                        
                        // Revertir el reemplazo de caracteres especiales
                        nombreReal = nombreReal.replace(/_/g, ' ').replace(/__/g, '_');
                        
                        console.log(`  üîÑ Mapeando: ${key} -> "${nombreReal}"`);
                        
                        // Buscar la variable que coincida en la lista
                        const variableCoincidente = todasVariables.find(v => 
                            v.replace(/[^a-zA-Z0-9]/g, '_') === key.replace('valor_', '')
                        );
                        
                        if (variableCoincidente) {
                            tablaVariables[variableCoincidente] = datosVariablesGuardados[key];
                            console.log(`  ‚úÖ Mapeo exitoso: ${key} -> ${variableCoincidente} = "${datosVariablesGuardados[key]}"`);
                        } else {
                            // Si no encuentra coincidencia exacta, usar el nombre corregido
                            tablaVariables[nombreReal] = datosVariablesGuardados[key];
                            console.log(`  ‚úÖ Usando nombre corregido: ${nombreReal} = "${datosVariablesGuardados[key]}"`);
                        }
                    } else {
                        // Si no empieza con "valor_", usar directamente
                        tablaVariables[key] = datosVariablesGuardados[key];
                        console.log(`  ‚úÖ Usando directamente: ${key} = "${datosVariablesGuardados[key]}"`);
                    }
                }
            });

            // üî• VERIFICACI√ìN ESPEC√çFICA DE LAS VARIABLES QUE NOS INTERESAN
            console.log('üîç VERIFICANDO VARIABLES CORREGIDAS...');
            const variablesImportantes = ['Allanamientos', 'Aeronaves (Und)', 'Aprehendidos/Detenidos'];
            
            variablesImportantes.forEach(variable => {
                const valor = tablaVariables[variable];
                if (valor && valor !== '0' && valor !== '') {
                    console.log(`  ‚úÖ ${variable}: "${valor}"`);
                } else {
                    console.log(`  ‚ùå ${variable}: NO ENCONTRADO (valor: "${valor}")`);
                    
                    // üî• INTENTAR BUSCAR EN LOS DATOS GUARDADOS CON DIFERENTES FORMATOS
                    const formatosPosibles = [
                        `valor_${variable.replace(/[^a-zA-Z0-9]/g, '_')}`,
                        `valor_${variable.replace(/[ ()]/g, '_')}`,
                        variable
                    ];
                    
                    for (const formato of formatosPosibles) {
                        if (datosVariablesGuardados[formato] && datosVariablesGuardados[formato] !== '') {
                            console.log(`  üîç Encontrado como ${formato}: "${datosVariablesGuardados[formato]}"`);
                            tablaVariables[variable] = datosVariablesGuardados[formato];
                            console.log(`  ‚úÖ Corregido: ${variable} = "${datosVariablesGuardados[formato]}"`);
                            break;
                        }
                    }
                }
            });

            // üî• RESUMEN FINAL
            const variablesConDatos = Object.keys(tablaVariables).filter(key => 
                tablaVariables[key] !== '0' && tablaVariables[key] !== ''
            ).length;
            
            console.log('üìä ========== RESUMEN FINAL ==========');
            console.log(`üìà Variables con datos: ${variablesConDatos} de ${todasVariables.length}`);
            
            // Mostrar TODAS las variables que se enviar√°n
            console.log('üöÄ VARIABLES QUE SE ENVIAR√ÅN AL SERVIDOR:');
            const variablesAEnviar = Object.keys(tablaVariables).filter(key => 
                tablaVariables[key] !== '0' && tablaVariables[key] !== ''
            );
            
            if (variablesAEnviar.length > 0) {
                variablesAEnviar.forEach(key => {
                    console.log(`  ‚úÖ ${key}: "${tablaVariables[key]}"`);
                });
            } else {
                console.log('  ‚ùå NO HAY VARIABLES PARA ENVIAR');
            }
            
            console.log('üîç ========== DIAGN√ìSTICO COMPLETADO ==========');
            
            return tablaVariables;
        }

        // ========== FUNCI√ìN MODIFICADA PARA ENV√çO A GOOGLE SHEETS ==========
        async function enviarDatosAGoogleSheets(datosCompletos) {
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            
            return new Promise((resolve, reject) => {
                try {
                    submitBtn.innerHTML = 'üîÑ Enviando...';
                    submitBtn.disabled = true;
                    
                    console.log('üì§ ========== INICIANDO ENV√çO A GOOGLE SHEETS ==========');
                    
                    // üî• PREPARAR DATOS SEG√öN LA NUEVA ESTRUCTURA
                    const datosParaEnviar = {
                        action: 'guardar_operativo',
                        idOperativo: datosCompletos.idOperativo,
                        timestamp: datosCompletos.timestamp,
                        
                        // Datos b√°sicos del operativo
                        fechaOperativo: datosCompletos.datosOperativos[0] || '',
                        horaOperativo: datosCompletos.datosOperativos[1] || '',
                        direccionInterventora: datosCompletos.datosOperativos[2] || '',
                        unidadInterventora: datosCompletos.datosOperativos[3] || '',
                        codigoSubcircuito: datosCompletos.datosOperativos[4] || '',
                        zona: datosCompletos.datosOperativos[5] || '',
                        subzona: datosCompletos.datosOperativos[6] || '',
                        distrito: datosCompletos.datosOperativos[7] || '',
                        circuito: datosCompletos.datosOperativos[8] || '',
                        subcircuito: datosCompletos.datosOperativos[9] || '',
                        latitud: datosCompletos.datosOperativos[10] || '',
                        longitud: datosCompletos.datosOperativos[11] || '',
                        direccion: datosCompletos.datosOperativos[12] || '',
                        presuntoDelito: datosCompletos.datosOperativos[13] || '',
                        extractoCaso: datosCompletos.datosOperativos[14] || '',
                        tipoEjecucion: datosCompletos.datosOperativos[15] || '',
                        tipoCoordinacion: datosCompletos.datosOperativos[16] || '',
                        caracterizacionAprehendido: datosCompletos.datosOperativos[17] || '',
                        variablesProductividad: datosCompletos.datosOperativos[18] || '',
                        nivelIndicadores: datosCompletos.datosOperativos[19] || '',
                        
                        // Datos del responsable
                        cedula: datosCompletos.datosOperativos[20] || '',
                        grado: datosCompletos.datosOperativos[21] || '',
                        nombres: datosCompletos.datosOperativos[22] || '',
                        celular: datosCompletos.datosOperativos[23] || '',
                        correo: datosCompletos.datosOperativos[24] || '',
                        nombreArchivoPowerPoint: datosCompletos.datosOperativos[25] || '',
                        
                        // Tabla de variables
                        tablaVariables: diagnosticarMapeoVariables(),
                        
                        // Datos de detenidos
                        detenidos: datosCompletos.datosDetenidos || [],
                        totalDetenidos: datosCompletos.totalDetenidos || 0
                    };
                    
                    console.log('üì¶ Datos preparados para enviar:', datosParaEnviar);
                    
                    // üî• USAR XMLHttpRequest PARA ENV√çO CON LA URL √öNICA
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', APPS_SCRIPT_URL, true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    
                    xhr.onload = function() {
                        console.log('‚úÖ Respuesta recibida. Status:', xhr.status);
                        console.log('üì® Respuesta del servidor:', xhr.responseText);
                        
                        if (xhr.status === 200) {
                            try {
                                const resultado = JSON.parse(xhr.responseText);
                                console.log('‚úÖ Respuesta parseada:', resultado);
                                
                                if (resultado.success) {
                                    mostrarNotificacion('‚úÖ Datos enviados exitosamente', 'success', 5000);
                                    console.log('üéØ ENV√çO EXITOSO:');
                                    console.log('   üìä Operativo:', datosParaEnviar.idOperativo);
                                    console.log('   üë§ Detenidos:', datosParaEnviar.totalDetenidos);
                                    resolve(resultado);
                                } else {
                                    throw new Error(resultado.message || resultado.error || 'Error desconocido del servidor');
                                }
                            } catch (parseError) {
                                console.error('‚ùå Error parseando respuesta:', parseError);
                                mostrarNotificacion('‚ùå Error en la respuesta del servidor', 'error', 5000);
                                reject(parseError);
                            }
                        } else {
                            throw new Error(`Error HTTP: ${xhr.status} - ${xhr.statusText}`);
                        }
                        
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    };
                    
                    xhr.onerror = function() {
                        console.error('‚ùå Error de red en XMLHttpRequest');
                        mostrarNotificacion('‚ùå Error de conexi√≥n con el servidor', 'error', 5000);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        reject(new Error('Error de red'));
                    };
                    
                    xhr.ontimeout = function() {
                        console.error('‚ùå Timeout en XMLHttpRequest');
                        mostrarNotificacion('‚ùå Tiempo de espera agotado', 'error', 5000);
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                        reject(new Error('Timeout'));
                    };
                    
                    xhr.timeout = 30000; // 30 segundos
                    
                    console.log('üîÑ Enviando datos a Google Sheets via XMLHttpRequest');
                    xhr.send(JSON.stringify(datosParaEnviar));
                    
                } catch (error) {
                    console.error('‚ùå Error al enviar datos:', error);
                    mostrarNotificacion(`‚ùå Error al enviar: ${error.message}`, 'error', 5000);
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    reject(error);
                }
            });
        }

        // ========== FUNCI√ìN MODIFICADA PARA RECOPILAR DATOS COMPLETOS ==========
        function recopilarDatosCompletos() {
            // Generar la tabla completa de variables
            const tablaVariables = diagnosticarMapeoVariables();
            
            // Recopilar datos de detenidos
            const datosDetenidos = recopilarDatosDetenidos();
            const totalDetenidos = document.querySelectorAll('.detenido-container').length;
            
            // üî• ESTRUCTURA SIMPLIFICADA PARA EL NUEVO SCRIPT
            const datosOperativos = [
                // 1. INFORMACI√ìN GENERAL (18 campos)
                document.getElementById('fechaOperativo')?.value || '',
                document.getElementById('horaOperativo')?.value || '',
                document.getElementById('direccionInterventora')?.value || '',
                document.getElementById('unidadInterventora')?.value || '',
                document.getElementById('codigoSubcircuito')?.value || '',
                document.getElementById('zona')?.value || '',
                document.getElementById('subzona')?.value || '',
                document.getElementById('distrito')?.value || '',
                document.getElementById('circuito')?.value || '',
                document.getElementById('subcircuito')?.value || '',
                document.getElementById('latitud')?.value || '',
                document.getElementById('longitud')?.value || '',
                document.getElementById('direccion')?.value || '',
                document.getElementById('presuntoDelito')?.value || '',
                document.getElementById('extractoCaso')?.value || '',
                document.getElementById('tipoEjecucion')?.value || '',
                document.getElementById('tipoCoordinacion')?.value || '',
                document.getElementById('caracterizacionAprehendido')?.value || '',
                
                // 2. VARIABLE DE PRODUCTIVIDAD SELECCIONADA (1 campo)
                document.getElementById('variablesProductividad')?.value || '',
                
                // 3. INDICADORES Y RESPONSABLE (6 campos)
                document.getElementById('nivelIndicadores')?.value || 'NO',
                document.getElementById('numeroCedula')?.value || '',
                document.getElementById('grado')?.value || '',
                document.getElementById('apellidosNombres')?.value || '',
                document.getElementById('celular')?.value || '',
                document.getElementById('correoElectronico')?.value || '',
                
                // 4. POWERPOINT (1 campo)
                infoDriveGlobal.nombreArchivo || ''
            ];
            
            return {
                datosOperativos: datosOperativos,
                datosDetenidos: datosDetenidos,
                totalDetenidos: totalDetenidos,
                timestamp: new Date().toISOString(),
                idOperativo: window.idOperativoGlobal || generarIdOperativo()
            };
        }

        // ========== FUNCI√ìN PARA RECOPILAR DATOS DE DETENIDOS ==========
        function recopilarDatosDetenidos() {
            const datosDetenidos = [];
            const contenedores = document.querySelectorAll('.detenido-container');

            contenedores.forEach((contenedor, index) => {
                const id = index + 1;
                const datos = {
                    numero: id,
                    nombres: document.getElementById(`nombresDetenido-${id}`)?.value || '',
                    cedula: document.getElementById(`cedulaDetenido-${id}`)?.value || '',
                    edad: document.getElementById(`edadDetenido-${id}`)?.value || '',
                    nacionalidad: document.getElementById(`nacionalidadDetenido-${id}`)?.value || '',
                    cantidadDetenciones: document.getElementById(`cantidadDetenciones-${id}`)?.value || '0',
                    resolucionFlagrancia: document.getElementById(`resolucionFlagrancia-${id}`)?.value || '',
                    grupoDelictivo: document.getElementById(`grupoDelictivo-${id}`)?.value || '',
                    servidorPolicial: document.getElementById(`servidorPolicial-${id}`)?.value || ''
                };
                datosDetenidos.push(datos);
            });

            return datosDetenidos;
        }

        // ========== FUNCI√ìN PARA VALIDAR FORMULARIO COMPLETO ==========
        function validarFormularioCompleto() {
            let esValido = true;
            
            // Validar campos requeridos b√°sicos
            const camposRequeridos = [
                'fechaOperativo', 'horaOperativo', 'direccionInterventora', 
                'unidadInterventora', 'presuntoDelito', 'extractoCaso',
                'tipoEjecucion', 'tipoCoordinacion', 'caracterizacionAprehendido',
                'variablesProductividad', 'numeroCedula'
            ];
            
            camposRequeridos.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo && campo.hasAttribute('required') && !campo.value.trim()) {
                    esValido = false;
                    campo.classList.add('invalid');
                    
                    // Mostrar error espec√≠fico
                    const errorElement = document.getElementById(campoId + 'Error');
                    if (errorElement) {
                        errorElement.style.display = 'block';
                    }
                }
            });
            
            // Validar coordenadas
            if (!validarCoordenadas()) {
                esValido = false;
            }
            
            // Validar c√©dula
            if (!validarCedula()) {
                esValido = false;
            }
            
            return esValido;
        }

        // ========== NUEVAS FUNCIONES PARA POWERPOINT ==========
        function setupPowerPointEvents() {
            const fileInput = document.getElementById('powerpointFile');
            const selectedFileDiv = document.getElementById('selectedFile');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            // Solo manejar selecci√≥n de archivo, NO el env√≠o
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Validar tipo de archivo
                    const validTypes = ['application/vnd.ms-powerpoint', 
                                       'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                       'application/vnd.ms-powerpoint.presentation.macroEnabled.12'];
                    
                    if (!validTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.ppt') && 
                        !file.name.toLowerCase().endsWith('.pptx') && !file.name.toLowerCase().endsWith('.pptm')) {
                        mostrarNotificacion('Por favor, seleccione un archivo PowerPoint v√°lido (PPT, PPTX, PPTM)', 'error');
                        this.value = '';
                        selectedFileDiv.style.display = 'none';
                        return;
                    }
                    
                    // Validar tama√±o (50MB m√°ximo)
                    if (file.size > 50 * 1024 * 1024) {
                        mostrarNotificacion('El archivo es demasiado grande. El tama√±o m√°ximo permitido es 50MB.', 'error');
                        this.value = '';
                        selectedFileDiv.style.display = 'none';
                        return;
                    }
                    
                    // Mostrar informaci√≥n del archivo
                    fileName.textContent = file.name;
                    fileSize.textContent = formatFileSize(file.size);
                    selectedFileDiv.style.display = 'block';
                    
                    mostrarNotificacion('‚úÖ PowerPoint listo para enviar con el formulario', 'success', 3000);
                } else {
                    selectedFileDiv.style.display = 'none';
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ========== MODIFICADA: ENVIAR POWERPOINT CON ID ==========
        async function enviarPowerPoint(idOperativo) {
            const fileInput = document.getElementById('powerpointFile');
            const progressBar = document.getElementById('powerpointProgressBar');
            const progress = document.getElementById('powerpointProgress');
            
            if (!fileInput || fileInput.files.length === 0) {
                // ‚úÖ SILENCIO: No mostrar error, simplemente retornar
                return;
            }
            
            const file = fileInput.files[0];
            
            // Mostrar progreso silenciosamente
            progressBar.style.display = 'block';
            progress.style.width = '0%';
            
            try {
                // Convertir archivo a base64
                const base64Data = await fileToBase64(file);
                
                // Actualizar progreso
                progress.style.width = '50%';
                
                // Enviar usando XMLHttpRequest con nombre personalizado
                const result = await enviarPowerPointConXHR(base64Data, file.name, file.type, idOperativo);
                
                if (result.status === 'success') {
                    progress.style.width = '100%';
                    // ‚úÖ SILENCIO: No mostrar notificaci√≥n de √©xito
                } else {
                    // ‚úÖ SILENCIO: No mostrar error, solo log
                    console.log('PowerPoint no se pudo enviar:', result.message);
                }
                
                return result;
                
            } catch (error) {
                // ‚úÖ SILENCIO: No mostrar error al usuario
                console.error('Error al enviar PowerPoint:', error);
                throw error;
            } finally {
                // Ocultar barra de progreso despu√©s de un tiempo
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 3000);
            }
        }

        // üî• EN EL FORMULARIO - FUNCI√ìN enviarPowerPointConXHR
        function enviarPowerPointConXHR(base64Data, filename, mimeType, idOperativo) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                // Preparar datos seg√∫n la nueva estructura
                const datosParaEnviar = {
                    action: 'subir_powerpoint',
                    data: base64Data,
                    filename: `${idOperativo}_Informe_Operativo.pptx`,
                    mimeType: mimeType,
                    timestamp: new Date().toISOString(),
                    idOperativo: idOperativo
                };
                
                xhr.open('POST', APPS_SCRIPT_URL, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const resultado = JSON.parse(xhr.responseText);
                            console.log('‚úÖ Respuesta PowerPoint:', resultado);
                            resolve(resultado);
                        } catch (parseError) {
                            reject(new Error('Error parseando respuesta'));
                        }
                    } else {
                        reject(new Error(`Error HTTP: ${xhr.status}`));
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('Error de conexi√≥n'));
                };
                
                xhr.ontimeout = function() {
                    reject(new Error('Timeout'));
                };
                
                xhr.timeout = 60000;
                console.log('üîÑ Enviando PowerPoint...');
                xhr.send(JSON.stringify(datosParaEnviar));
            });
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // ========== MODIFICADA: ENV√çO COMBINADO ==========
        async function enviarPowerPointYRespuestas(datosCompletos, idOperativo) {
            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.innerHTML = 'üîÑ Enviando PowerPoint...';
                submitBtn.disabled = true;

                // 1. INCLUIR ID EN DATOS DEL FORMULARIO
                datosCompletos.idOperativo = idOperativo;
                
                // 2. ACTUALIZAR INFO DRIVE CON EL NOMBRE
                actualizarInfoDriveGlobal(idOperativo);
                
                // 3. ENVIAR POWERPOINT CON NOMBRE PERSONALIZADO
                const fileInput = document.getElementById('powerpointFile');
                if (fileInput && fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const validTypes = ['application/vnd.ms-powerpoint', 
                                       'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                                       'application/vnd.ms-powerpoint.presentation.macroEnabled.12'];
                    
                    if ((validTypes.includes(file.type) || 
                        file.name.toLowerCase().endsWith('.ppt') || 
                        file.name.toLowerCase().endsWith('.pptx') || 
                        file.name.toLowerCase().endsWith('.pptm')) &&
                        file.size <= 50 * 1024 * 1024) {
                        
                        try {
                            await enviarPowerPoint(idOperativo);
                            console.log('‚úÖ PowerPoint enviado con nombre:', `${idOperativo}_Informe_Operativo.pptx`);
                        } catch (error) {
                            console.log('‚ö†Ô∏è PowerPoint no enviado (continuando con formulario)');
                        }
                    }
                }

                // 4. ENVIAR DATOS DEL FORMULARIO
                submitBtn.innerHTML = 'üîÑ Enviando respuestas...';
                
                await enviarDatosAGoogleSheets(datosCompletos);

                // 5. MOSTRAR CONFIRMACI√ìN CON ID
                mostrarConfirmacionConId(idOperativo);

            } catch (error) {
                console.error('Error en el proceso de env√≠o:', error);
                if (error.message.includes('Error al enviar los datos')) {
                    mostrarNotificacion('‚ùå Error inesperado al procesar el formulario', 'error', 5000);
                }
                throw error;
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // ========== FUNCI√ìN PARA LIMPIAR COMPLETAMENTE EL FORMULARIO ==========
        function limpiarFormularioCompleto() {
            console.log('üßπ Limpiando formulario completo...');
            
            // 1. Limpiar formulario principal
            document.getElementById('operativeForm').reset();
            
            // 2. Limpiar campos de solo lectura
            document.querySelectorAll('.readonly').forEach(campo => {
                campo.value = '';
                campo.classList.remove('auto-filled', 'valid', 'invalid');
            });
            
            // 3. Limpiar secci√≥n de variables de productividad
            document.getElementById('variableSectionsContainer').innerHTML = '';
            document.getElementById('validationSummary').style.display = 'none';
            document.getElementById('variablesProductividad').selectedIndex = 0;
            
            // 4. Limpiar secci√≥n de detenidos
            document.getElementById('detenidosContainer').innerHTML = '';
            detenidoCount = 0;
            document.getElementById('totalDetenidos').textContent = '0';
            document.getElementById('seccionDetenidos').style.display = 'none';
            
            // 5. Limpiar estados y mensajes
            document.getElementById('unidadesStatus').textContent = '';
            document.getElementById('dataStatus').textContent = '';
            document.getElementById('cedulaStatus').textContent = '';
            document.getElementById('locationStatus').textContent = '';
            
            // 6. Limpiar mapa y ubicaci√≥n
            if (marker) {
                marker.setLatLng([-1.8312, -78.1834]);
            }
            if (map) {
                map.setView([-1.8312, -78.1834], 6);
            }
            document.getElementById('selectedLocationInfo').style.display = 'none';
            document.getElementById('direccion').value = '';
            
            // 7. Limpiar PowerPoint
            const fileInput = document.getElementById('powerpointFile');
            if (fileInput) {
                fileInput.value = '';
            }
            document.getElementById('selectedFile').style.display = 'none';
            document.getElementById('powerpointProgressBar').style.display = 'none';
            
            // 8. Limpiar barra de progreso
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').style.background = 'linear-gradient(135deg, #2a5298, #667eea)';
            
            // 9. Limpiar datos guardados en memoria
            datosVariablesGuardados = {};
            
            // 10. Restablecer fecha y hora actual
            const ahora = new Date();
            document.getElementById('fechaOperativo').value = ahora.toISOString().split('T')[0];
            document.getElementById('horaOperativo').value = ahora.toTimeString().slice(0,5);
            
            // 11. Restablecer unidades
            actualizarUnidades();
            
            // 12. Ocultar secci√≥n de responsable
            document.getElementById('seccionResponsable').style.display = 'none';
            document.getElementById('nivelIndicadores').selectedIndex = 0;
            
            // 13. Limpiar ID del operativo
            const idDisplay = document.getElementById('idOperativoDisplay');
            if (idDisplay) {
                idDisplay.remove();
            }
            
            console.log('‚úÖ Formulario limpiado completamente');
        }

        // ========== EVENT LISTENERS ==========
        document.getElementById('direccionInterventora').addEventListener('change', actualizarUnidades);
        document.getElementById('numeroCedula').addEventListener('input', validarCedula);
        
        document.getElementById('presuntoDelito').addEventListener('input', function(e) {
            buscarDelitos(e.target.value);
        });
        
        document.getElementById('presuntoDelito').addEventListener('blur', function() {
            setTimeout(() => {
                document.getElementById('delitoSearchResults').style.display = 'none';
            }, 200);
        });
        
        document.getElementById('codigoSubcircuito').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            
            const codigo = e.target.value.trim();
            if (codigo.length >= 2) {
                clearTimeout(window.subcircuitoTimeout);
                window.subcircuitoTimeout = setTimeout(() => buscarSubcircuito(codigo), 500);
            }
            
            actualizarBarraProgreso();
        });
        
        document.getElementById('btnObtenerUbicacion').addEventListener('click', obtenerUbicacion);
        document.getElementById('btnMostrarMapa').addEventListener('click', mostrarMapa);
        document.getElementById('btnOcultarMapa').addEventListener('click', ocultarMapa);
        
        document.getElementById('latitud').addEventListener('input', function() {
            this.value = this.value.replace('.', ',');
            validarCoordenadas();
            actualizarBarraProgreso();
        });
        
        document.getElementById('longitud').addEventListener('input', function() {
            this.value = this.value.replace('.', ',');
            validarCoordenadas();
            actualizarBarraProgreso();
        });

        // Event listeners para el mapa
        document.getElementById('mapSearch').addEventListener('input', function(e) {
            buscarDireccion(e.target.value);
        });
        
        document.getElementById('mapSearch').addEventListener('focus', function() {
            const results = document.getElementById('mapSearchResults');
            if (results.children.length > 0) {
                results.style.display = 'block';
            }
        });

        // Event listener para variables de productividad
        document.getElementById('variablesProductividad').addEventListener('change', function() {
            // üî• GUARDAR DATOS ANTES DE CAMBIAR
            guardarDatosVariableActual();
            
            gestionarVariableProductividad();
            actualizarBarraProgreso();
            
            // Si se cambia a una variable diferente a "Aprehendidos/Detenidos", ocultar secci√≥n de detenidos
            if (this.value !== "Aprehendidos/Detenidos") {
                document.getElementById('seccionDetenidos').style.display = 'none';
            }
            
            // NUEVO: Resetear requeridos al cambiar variable
            if (this.value === "Aprehendidos/Detenidos") {
                setTimeout(gestionarRequeridosSegunValidacion, 100);
            }
        });

        // Event listener para indicadores adicionales
        document.getElementById('nivelIndicadores').addEventListener('change', function() {
            gestionarIndicadoresAdicionales();
            actualizarBarraProgreso();
        });

        // ========== NUEVO EVENT LISTENER PARA POWERPOINT ==========
        setupPowerPointEvents();

        // ========== NUEVO EVENT LISTENER PARA CERRAR CONFIRMACI√ìN ==========
        document.getElementById('btnCloseConfirmation').addEventListener('click', function() {
            const confirmationOverlay = document.getElementById('confirmationOverlay');
            if (confirmationOverlay) {
                confirmationOverlay.classList.remove('show');
                // Tambi√©n limpiar el formulario si se cierra manualmente
                limpiarFormularioCompleto();
            }
        });

        document.querySelectorAll('input, select, textarea').forEach(campo => {
            campo.addEventListener('input', actualizarBarraProgreso);
            campo.addEventListener('change', actualizarBarraProgreso);
        });

        // Cerrar sugerencias de delitos al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.delito-search-container')) {
                document.getElementById('delitoSearchResults').style.display = 'none';
            }
            if (!e.target.closest('.map-search-container')) {
                document.getElementById('mapSearchResults').style.display = 'none';
            }
        });

        // ========== MODIFICADO: SUBMIT PRINCIPAL ==========
        document.getElementById('operativeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('üîÑ Iniciando proceso de env√≠o COMBINADO...');
            
            // 1. GENERAR Y MOSTRAR ID √öNICO
            const idOperativo = mostrarIdOperativo();
            
            // 2. ACTUALIZAR INFORMACI√ìN GLOBAL
            actualizarInfoDriveGlobal(idOperativo);
            
            // 3. VALIDACIONES
            if (!validarFormularioCompleto()) {
                mostrarNotificacion('‚ùå Error: Complete todos los campos requeridos', 'error', 5000);
                return;
            }
            
            if (!validarTodasVariablesProductividad()) {
                mostrarNotificacion('‚ùå Error: Complete correctamente el campo de la variable de productividad seleccionada', 'error', 5000);
                return;
            }
            
            if (!validarTodosDetenidos()) {
                mostrarNotificacion('‚ùå Error: Complete correctamente los datos de los detenidos', 'error', 5000);
                return;
            }
            
            // 4. RECOPILAR DATOS
            const datosCompletos = recopilarDatosCompletos();
            
            // 5. CONFIRMACI√ìN
            if (confirm(`¬øEst√° seguro de que desea enviar el formulario?\n\n‚úÖ ID del Operativo: ${idOperativo}\n‚úÖ Archivo en Drive: ${infoDriveGlobal.nombreArchivo}\n‚úÖ Detenidos: ${datosCompletos.totalDetenidos} registros`)) {
                try {
                    await enviarPowerPointYRespuestas(datosCompletos, idOperativo);
                } catch (error) {
                    console.error('Error en el proceso de env√≠o:', error);
                }
            }
        });

        // ========== INICIALIZACI√ìN ==========
        document.addEventListener('DOMContentLoaded', function() {
            const ahora = new Date();
            document.getElementById('fechaOperativo').value = ahora.toISOString().split('T')[0];
            document.getElementById('horaOperativo').value = ahora.toTimeString().slice(0,5);
            
            actualizarUnidades();
            
            // Ocultar la secci√≥n de responsable inicialmente
            document.getElementById('seccionResponsable').style.display = 'none';
            
            console.log('‚úÖ Formulario completo inicializado correctamente');
            console.log('üîó URL √öNICA:', APPS_SCRIPT_URL);
            console.log('üìä Sistema adaptado al nuevo Google Apps Script');
            console.log('üéØ Acciones disponibles:');
            console.log('   - buscar_cedula');
            console.log('   - buscar_subcircuito');
            console.log('   - guardar_operativo');
            console.log('   - subir_powerpoint');
            
            mostrarNotificacion('Formulario completo cargado correctamente. Seleccione una Variable de Productividad para continuar.', 'info', 4000);
        });
    </script>
</body>
</html>
